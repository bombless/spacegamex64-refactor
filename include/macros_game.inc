; MACROS_GAME.INC - Game logic macros

IFNDEF MACROS_GAME_INC
MACROS_GAME_INC EQU 1


;GAME LOGIC MACROS
RESETGAME MACRO
	LOCAL CLEARTILEMAPS
	LOCAL CLEARBUFF
	LOCAL CLEARBOLTS
	LOCAL CLEARENEMIES
	;RESET ALL VARIABLES
	MOV STAGE, 00H
	MOV SHIPX, 00H
	MOV SHIPY, 00H
	MOV SHIPTILTY, 00H
	XOR RAX, RAX
	MOV BYTE PTR [SHIPHITBOX], AL
	MOV BYTE PTR [SHIPHITBOX + 01H], AL
	MOV BYTE PTR [SHIPHITBOX + 02H], AL
	MOV BYTE PTR [SHIPHITBOX + 03H], AL
	MOV BYTE PTR [SHIPALT], AL
	MOV BYTE PTR [SHIPFUEL], AL
	MOV SCROLLTIMER, 00H
	MOV SCROLLX, 00H
	MOV SCROLLY, 00H
	MOV LASTSCROLLX, 00H
	MOV LASTSCROOLY, 00H
	MOV GAMEMAPOFFSET, 0258H
	MOV COLUMNTICK, 00H
	MOV HIDESHADOW, 00H
	MOV HIT, 00H
	MOV NOFUEL, 00H
	MOV PAUSESCROLL, 00H
	MOV EXPLODETIMER, 00H
	MOV RESET, 00H
	MOV EXPLODEDELAYTIMER, 00H
	MOV WINTIMER, 00H


	MOV BYTE PTR [TM0XOFFSET], 00H
	MOV BYTE PTR [TM0YOFFSET], 00H
	MOV BYTE PTR [TM1XOFFSET], 00H
	MOV BYTE PTR [TM1YOFFSET], 00H
	;CLEAR TILEMAPS
	XOR RAX, RAX
	MOV RCX, 0400H
	LEA RDX, QWORD PTR [TILEMAP0]
	LEA RBX, QWORD PTR [TILEMAP1]
	CLEARTILEMAPS:
		MOV WORD PTR [RDX], AX
		MOV WORD PTR [RBX], AX
		ADD RDX, 02H
		ADD RBX, 02H
		LOOP CLEARTILEMAPS

	;FRAMERULES:
	MOV MOVEMENTFRAMERULEC, 00H
	MOV SCROLLFRAMERULEC, 00H
	MOV FUELFRAMERULEC, 00H	
	MOV ELOGICFRAMERULEC, 00H
	MOV EXPLODEFRAMERULEC, 00H
	
	;CLEAR BUFFER
	MOV RCX, 010000H
	LEA RDX, QWORD PTR [OUTPUTFBUFFER]
	XOR RAX, RAX
	CLEARBUFF:
		MOV DWORD PTR [RDX], EAX
		ADD RDX, 04H
		LOOP CLEARBUFF
	
	;CLEAR BOLTS:
	MOV RCX, 08H
	LEA RDX, QWORD PTR [BOLTS]
	CLEARBOLTS:
		MOV [RDX], RAX
		ADD RDX, BOLTOBJSIZE
		LOOP CLEARBOLTS
	
	;CLEAR ENEMIES:
	MOV RCX, NUMBEROFENEMY
	LEA RDX, QWORD PTR [ENEMY]
	CLEARENEMIES:
		MOV [RDX], RAX
		ADD RDX, ENEMYOBJSIZE
		LOOP CLEARENEMIES
	
	;INIT GRAPHICS
	GRAPHICSINIT
	
	;UNPAUSE
	MOV PAUSEGAME, 00H
ENDM


LOADINNEXTSECTIONOFMAP MACRO
	;SCREEN READJUSTED ALREADY, CLEAN TO STORE AT TOP AND SIDE OF SCREEN
	;GAMEMAPOFFSET ALREADY AT PROPER GAMEMAP OFFSET
	LOCAL TILESTOPLOOP
	LOCAL TILESSIDELOOP
	LEA RBX, QWORD PTR [TILEMAP0]
	ADD RBX, 022H
	LEA RDX, QWORD PTR [tilemap]
	ADD RDX, GAMEMAPOFFSET
	
	XOR R8, R8
	MOV RCX, 0FH
	;COPY 15 TILES TO TOP RIGHT OF GAME AREA
		;X: 14, Y:0
	TILESTOPLOOP:
		MOV AX, WORD PTR [RDX + R8]	;TAKE FROM DATA TILE MAP
		MOV WORD PTR [RBX], AX	;PLACE IN VRAM TILE MAP
		INC RBX
		INC RBX
		INC R8
		INC R8
		LOOP TILESTOPLOOP
	
	;ADD 38 MORE TILES TO SIDE (2 PER ROW)
	ADD RBX, 03CH
	MOV RCX, 00H
	TILESSIDELOOP:
		MOV AX, WORD PTR [RDX + R8]	;TAKE FROM DATA TILE MAP
		MOV WORD PTR [RBX], AX	;PLACE IN VRAM TILE MAP
		INC RBX
		INC RBX
		INC R8
		INC R8
		INC RCX
		TEST RCX, 01H
		JNZ TILESSIDELOOP
			;INCREASE DESTINATION BY 30 TILES
			ADD RBX, 03CH
			CMP RCX, 026H
			JNZ TILESSIDELOOP
	ADD R8, GAMEMAPOFFSET
	MOV GAMEMAPOFFSET, R8
ENDM

COLUMNTICKEVENTS MACRO
	;EVENTS RELATED TO SCROLLING MAP TRIGGERED AT CERTAIN COLUMNS
		;INCLUDING: SHIP SHADOW ON/OFF, SPAWN ENEMIES, &C.
		;EVENTS BROKEN UP BY STAGE
	LOCAL STAGE1EVENTS
	LOCAL STAGE2EVENTS
	LOCAL STAGE3EVENTS
	LOCAL ENDCOLUMNTICKEVENTS

	MOV RAX, COLUMNTICK
	MOV RBX, STAGE
	CMP RBX, 02H
	JZ STAGE3EVENTS
	CMP RBX, 01H
	JZ STAGE2EVENTS
	JMP STAGE1EVENTS


	;COULD BE REDESIGNED INTO A JUMP TABLE FOR QUICKER ACCESS
	;FROM SIDE TO NEW TILES IS 128px
	
	STAGE3EVENTS:	;2ND FLYOVER AREA
		S3E1:
			CMP RAX, 0A8H
			JNZ S3E2
			MOV R8, 01H	;SPAWN ENTRY WALLS
			SPAWNENEMY 50, 0, 0
			JMP ENDCOLUMNTICKEVENTS
		S3E2:
			CMP RAX, 0ACH
			JNZ S3E3
			MOV HIDESHADOW, 01H	;HIDE SHADOW
			JMP ENDCOLUMNTICKEVENTS
		S3E3:
			CMP RAX, 0B2H
			JNZ S3E4
			MOV HIDESHADOW, 00H	;UNHIDE SHADOW
			MOV R8, 026H	;SPAWN DISH
			SPAWNENEMY 229, 104, 0
			JMP ENDCOLUMNTICKEVENTS
		S3E4:
			CMP RAX, 0AAH
			JNZ S3E5
			MOV R8, 025H	;TANKER
			SPAWNENEMY 221, 56, 0
			JMP ENDCOLUMNTICKEVENTS
		S3E5:
			CMP RAX, 0A4H
			JNZ S3E6
			MOV R8, 022H	;WALL
			SPAWNENEMY 229, 32, 3
			JMP ENDCOLUMNTICKEVENTS
		S3E6:
			CMP RAX, 0A5H
			JNZ S3E7
			MOV R8, 022H	;WALL
			SPAWNENEMY 237, 51, 3
			JMP ENDCOLUMNTICKEVENTS
		S3E7:
			CMP RAX, 0AFH
			JNZ S3E8
			MOV R8, 024H	;SIDE TURRENT
			SPAWNENEMY 226, 110, 0
			JMP ENDCOLUMNTICKEVENTS
		S3E8:
			CMP RAX, 0ADH
			JNZ S3E9
			MOV R8, 023H	;FRONT TURRENT
			SPAWNENEMY 222, 25, 0
			JMP ENDCOLUMNTICKEVENTS
		S3E9:
			CMP RAX, 0B0H
			JNZ S3E10
			MOV R8, 025H	;TANKER
			SPAWNENEMY 229, 72, 0
			JMP ENDCOLUMNTICKEVENTS
		S3E10:
			CMP RAX, 0B1H
			JNZ S3E12
			MOV R8, 021H	;WALL
			SPAWNENEMY 205, 4, 1
			JMP ENDCOLUMNTICKEVENTS
		S3E12:
			CMP RAX, 0B5H
			JNZ S3E13_25
			MOV R8, 022H	;WALL
			SPAWNENEMY 237, 83, 1
			MOV R8, 01CH	;UP MISSLE
			SPAWNENEMY 221, 52, 0
			JMP ENDCOLUMNTICKEVENTS
		S3E13_25:
			CMP RAX, 0B8H
			JNZ S3E13_5
			MOV R8, 03H	;LOW WALLS
			SPAWNENEMY 0, 0, 0
			JMP ENDCOLUMNTICKEVENTS
		S3E13_5:
			CMP RAX, 0BCH
			JNZ S3E13
			MOV HIDESHADOW, 01H	;HIDE SHADOW
			JMP ENDCOLUMNTICKEVENTS
		S3E13:
			CMP RAX, 0BDH
			JNZ S3E14
			MOV R8, 01CH	;UP MISSLE
			SPAWNENEMY 229, 95, 0
			JMP ENDCOLUMNTICKEVENTS
		S3E14:
			CMP RAX, 0BBH
			JNZ S3E15
			MOV R8, 025H	;TANKER
			SPAWNENEMY 238, 51, 0
			JMP ENDCOLUMNTICKEVENTS
		S3E15:
			CMP RAX, 0BEH
			JNZ S3E16
			MOV R8, 025H	;TANKER
			SPAWNENEMY 225, 57, 0
			MOV R8, 023H	;FRONT TURRENT
			SPAWNENEMY 228, 26, 0
			JMP ENDCOLUMNTICKEVENTS
		S3E16:
			CMP RAX, 0C0H
			JNZ S3E17
			MOV R8, 025H	;TANKER
			SPAWNENEMY 229, 55, 0
			JMP ENDCOLUMNTICKEVENTS
		S3E17:
			CMP RAX, 0C2H
			JNZ S3E18
			MOV R8, 023H	;FRONT TURRENT
			SPAWNENEMY 226, 91, 0
			MOV HIDESHADOW, 00H	;UNHIDE SHADOW
			JMP ENDCOLUMNTICKEVENTS
		S3E18:
			CMP RAX, 0C5H
			JNZ S3E19
			MOV R8, 022H	;WALL
			SPAWNENEMY 229, 48, 2
			MOV R8, 01CH	;UP MISSLE
			SPAWNENEMY 213, 16, 0
			JMP ENDCOLUMNTICKEVENTS
		S3E19:
			CMP RAX, 0C7H
			JNZ S3E20
			MOV R8, 022H	;WALL
			SPAWNENEMY 223, 76, 2
			JMP ENDCOLUMNTICKEVENTS
		S3E20:
			CMP RAX, 0C9H
			JNZ S3E21
			MOV R8, 02H	;MEDIUM WALLS
			SPAWNENEMY 0, 0, 0
			MOV R8, 025H	;TANKER
			SPAWNENEMY 233, 29, 0
			JMP ENDCOLUMNTICKEVENTS
		S3E21:
			CMP RAX, 0CDH
			JNZ S3E22
			MOV HIDESHADOW, 01H	;HIDE SHADOW
			JMP ENDCOLUMNTICKEVENTS
		S3E22:
			CMP RAX, 0D3H
			JNZ S3E23
			MOV HIDESHADOW, 00H	;UNHIDE SHADOW
			JMP ENDCOLUMNTICKEVENTS
		S3E23:
			CMP RAX, 0CBH
			JNZ S3E24
			MOV R8, 025H	;TANKER
			SPAWNENEMY 237, 59, 0
			MOV R8, 01CH	;UP MISSLE
			SPAWNENEMY 229, 80, 0
			JMP ENDCOLUMNTICKEVENTS
		S3E24:
			CMP RAX, 0CEH
			JNZ S3E25
			MOV R8, 025H	;TANKER
			SPAWNENEMY 229, 87, 0
			JMP ENDCOLUMNTICKEVENTS
		S3E25:
			CMP RAX, 0CCH
			JNZ S3E26
			MOV R8, 01CH	;UP MISSLE
			SPAWNENEMY 238, 28, 0
			JMP ENDCOLUMNTICKEVENTS
		S3E26:
			CMP RAX, 0D1H
			JNZ S3E27
			MOV R8, 024H	;SIDE TURRENT
			SPAWNENEMY 226, 110, 0
			JMP ENDCOLUMNTICKEVENTS
		S3E27:
			CMP RAX, 0CFH
			JNZ S3E28
			MOV R8, 022H	;WALL
			SPAWNENEMY 229, 8, 0
			JMP ENDCOLUMNTICKEVENTS
		S3E28:
			CMP RAX, 0D0H
			JNZ S3E29
			MOV R8, 021H	;WALL
			SPAWNENEMY 237, 28, 0
			JMP ENDCOLUMNTICKEVENTS
		S3E29:
			CMP RAX, 0D5H
			JNZ S3E30
			MOV R8, 022H	;WALL
			SPAWNENEMY 229, 104, 0
			MOV R8, 023H	;FRONT TURRENT
			SPAWNENEMY 232, 24, 0
			JMP ENDCOLUMNTICKEVENTS
		S3E30:
			CMP RAX, 0D2H
			JNZ S3E31
			MOV R8, 01CH	;UP MISSLE
			SPAWNENEMY 237, 12, 0
			JMP ENDCOLUMNTICKEVENTS
		S3E31:
			CMP RAX, 0D8H
			JNZ S3E32
			MOV R8, 025H	;TANKER
			SPAWNENEMY 233, 17, 0
			JMP ENDCOLUMNTICKEVENTS
		S3E32:
			CMP RAX, 0DBH
			JNZ S3E33_5
			MOV R8, 023H	;FRONT TURRENT
			SPAWNENEMY 236, 100, 0
			MOV HIDESHADOW, 01H	;HIDE SHADOW
			JMP ENDCOLUMNTICKEVENTS
		S3E33_5:
			CMP RAX, 0DCH
			JNZ S3E33
			JMP ENDCOLUMNTICKEVENTS
		S3E33:
			CMP RAX, 0DDH
			JNZ S3E34
			MOV R8, 025H	;TANKER
			SPAWNENEMY 229, 47, 0
			JMP ENDCOLUMNTICKEVENTS
		S3E34:
			CMP RAX, 0DFH
			JNZ S3E35
			MOV R8, 026H	;SPAWN DISH
			SPAWNENEMY 238, 108, 0
			MOV HIDESHADOW, 00H	;UNHIDE SHADOW
			JMP ENDCOLUMNTICKEVENTS
		S3E35:
			CMP RAX, 0E0H
			JNZ S3E36
			MOV R8, 023H	;FRONT TURRENT
			SPAWNENEMY 234, 75, 0
			JMP ENDCOLUMNTICKEVENTS
		S3E36:
			CMP RAX, 0E1H
			JNZ S3E37
			MOV R8, 021H	;WALL
			SPAWNENEMY 205, 4, 1
			JMP ENDCOLUMNTICKEVENTS
		S3E37:
			CMP RAX, 0E4H
			JNZ S3E38
			MOV R8, 022H	;WALL
			SPAWNENEMY 229, 64, 1
			JMP ENDCOLUMNTICKEVENTS
		S3E38:
			CMP RAX, 0E5H
			JNZ S3E39
			MOV R8, 022H	;WALL
			SPAWNENEMY 238, 84, 1
			MOV R8, 01CH	;UP MISSLE
			SPAWNENEMY 222, 51, 0
			MOV R8, 025H	;TANKER
			SPAWNENEMY 237, 15, 0
			JMP ENDCOLUMNTICKEVENTS
		S3E39:
			CMP RAX, 0E8H
			JNZ S3E48
			MOV R8, 03H	;LOW WALLS
			SPAWNENEMY 0, 0, 0
			JMP ENDCOLUMNTICKEVENTS
		S3E48:
			CMP RAX, 0EBH
			JNZ S3E49
			MOV HIDESHADOW, 01H	;HIDE SHADOW
			JMP ENDCOLUMNTICKEVENTS
		S3E49:
			CMP RAX, 0F8H
			JNZ S3E50
			MOV PAUSESCROLL, 01H	;PAUSE SCROLL
			MOV R8, 04H	;BOSS
			SPAWNENEMY 172, 66, 2
			JMP ENDCOLUMNTICKEVENTS
		S3E50:
			CMP RAX, 0F2H
			JNZ S3E51
			MOV HIDESHADOW, 00H	;UNHIDE SHADOW
			JMP ENDCOLUMNTICKEVENTS
		S3E51:
		JMP ENDCOLUMNTICKEVENTS
	
	STAGE2EVENTS:	;SPACE EVENTS
		S2E1:
			CMP RAX, 072H
			JNZ S2E2
			MOV HIDESHADOW, 01H	;TURN SHADOW OFF
			JMP ENDCOLUMNTICKEVENTS
		S2E2:
			CMP RAX, 070H
			JNZ S2E3
			MOV R8, 011H	;TARGETED SPACE PLANE
			SPAWNENEMY 0, 0, 0
			JMP ENDCOLUMNTICKEVENTS
			
		S2E3:
			CMP RAX, 070H
			JNZ S2E4
			MOV R8, 011H	;TARGETED SPACE PLANE
			SPAWNENEMY 0, 0, 0
			JMP ENDCOLUMNTICKEVENTS
		S2E4:
			CMP RAX, 074H
			JNZ S2E5
			MOV R8, 011H	;TARGETED SPACE PLANE
			SPAWNENEMY 0, 0, 0
			JMP ENDCOLUMNTICKEVENTS
		S2E5:
			CMP RAX, 078H
			JNZ S2E6
			MOV R8, 011H	;TARGETED SPACE PLANE
			SPAWNENEMY 0, 0, 0
			JMP ENDCOLUMNTICKEVENTS
		S2E6:
			CMP RAX, 07CH
			JNZ S2E7
			MOV R8, 011H	;TARGETED SPACE PLANE
			SPAWNENEMY 0, 0, 0
			JMP ENDCOLUMNTICKEVENTS
		S2E7:
			CMP RAX, 080H
			JNZ S2E8
			MOV R8, 011H	;TARGETED SPACE PLANE
			SPAWNENEMY 0, 0, 0
			JMP ENDCOLUMNTICKEVENTS
		S2E8:
			CMP RAX, 084H
			JNZ S2E9
			MOV R8, 011H	;TARGETED SPACE PLANE
			SPAWNENEMY 0, 0, 0
			JMP ENDCOLUMNTICKEVENTS
		S2E9:
			CMP RAX, 088H
			JNZ S2E10
			MOV R8, 011H	;TARGETED SPACE PLANE
			SPAWNENEMY 0, 0, 0
			JMP ENDCOLUMNTICKEVENTS
		S2E10:
			CMP RAX, 08CH
			JNZ S2E11
			MOV R8, 011H	;TARGETED SPACE PLANE
			SPAWNENEMY 0, 0, 0
			JMP ENDCOLUMNTICKEVENTS
		S2E11:
			CMP RAX, 090H
			JNZ S2E12
			MOV R8, 011H	;TARGETED SPACE PLANE
			SPAWNENEMY 0, 0, 0
			JMP ENDCOLUMNTICKEVENTS
		S2E12:
			CMP RAX, 094H
			JNZ S2E13
			MOV R8, 011H	;TARGETED SPACE PLANE
			SPAWNENEMY 0, 0, 0
			JMP ENDCOLUMNTICKEVENTS
		S2E13:
			CMP RAX, 09CH
			JNZ ENDCOLUMNTICKEVENTS
			MOV HIDESHADOW, 00H	;TURN SHADOW BACK ON
			INC STAGE	;MOVE TO NEXT STAGE
			JMP ENDCOLUMNTICKEVENTS
		JMP ENDCOLUMNTICKEVENTS
	
	STAGE1EVENTS:	;1ST FLYOVER AREA
		S1E0:	;TURN SHADOW OFF FOR WALL FLYOVER + FRONT TURRENT
			CMP RAX, 09H
			JNZ S1E1				
			MOV HIDESHADOW, 01H
			MOV R8, 023H	;SPAWN FRONT FACING TURRENT
			SPAWNENEMY 239, 40, 0
			JMP ENDCOLUMNTICKEVENTS
		S1E1:	;TURN ON SHADOW AFTER WALL FLYOVER
			CMP RAX, 0FH
			JNZ S1E2
			MOV HIDESHADOW, 00H
			JMP ENDCOLUMNTICKEVENTS
		S1E2:	
			CMP RAX, 0BH
			JNZ S1E3
			MOV R8, 026H	;SPAWN DISH
			SPAWNENEMY 218, 112, 0
			JMP ENDCOLUMNTICKEVENTS
		S1E3:	;SPAWNING WALL OF ENEMIES IN FRONT
			CMP RAX, 05H
			JNZ S1E4
			MOV R8, 01H	;SPAWN ENTRY WALLS
			SPAWNENEMY 50, 0, 0
			JMP ENDCOLUMNTICKEVENTS
		S1E4:	;SPAWNING SIDE TURRENT
			CMP RAX, 0EH
			JNZ S1E5
			MOV R8, 024H	;SIDE TURRENT
			SPAWNENEMY 216, 116, 0
			MOV R8, 01CH	;UP MISSLE
			SPAWNENEMY 230, 25, 0
			JMP ENDCOLUMNTICKEVENTS
		S1E5:	;SPAWN TANKER
			CMP RAX, 011H
			JNZ S1E6
			MOV R8, 025H	;TANKER
			SPAWNENEMY 217, 30, 0
			MOV R8, 01CH	;UP MISSLE
			SPAWNENEMY 197, 86, 0
			JMP ENDCOLUMNTICKEVENTS
		S1E6:	;SPAWN UP MISSLE
			CMP RAX, 07H
			JNZ S1E7
			MOV R8, 01CH	;UP MISSLE
			SPAWNENEMY 229, 60, 0
			JMP ENDCOLUMNTICKEVENTS
		S1E7:	;SPAWN UP MISSLE
			CMP RAX, 0DH
			JNZ S1E8
			MOV R8, 01CH	;UP MISSLE
			SPAWNENEMY 221, 30, 0
			JMP ENDCOLUMNTICKEVENTS
		S1E8:
			CMP RAX, 012H
			JNZ S1E9
			MOV R8, 025H	;TANKER
			SPAWNENEMY 217, 70, 0
			JMP ENDCOLUMNTICKEVENTS
		S1E9:
			CMP RAX, 015H
			JNZ S1E10
			MOV R8, 01CH	;UP MISSLE
			SPAWNENEMY 200, 128, 0
			JMP ENDCOLUMNTICKEVENTS
		S1E10:
			CMP RAX, 017H
			JNZ S1E11
			MOV R8, 025H	;TANKER
			SPAWNENEMY 225, 114, 0
			MOV R8, 022H	;WALL
			SPAWNENEMY 229, 61, 0
			JMP ENDCOLUMNTICKEVENTS		
		S1E11:
			CMP RAX, 018H
			JNZ S1E12
			MOV R8, 022H	;WALL
			SPAWNENEMY 237, 81, 0
			JMP ENDCOLUMNTICKEVENTS
		S1E12:
			CMP RAX, 01AH
			JNZ S1E13
			MOV R8, 024H	;SIDE TURRENT
			SPAWNENEMY 226, 66, 0
			MOV R8, 01CH	;UP MISSLE
			SPAWNENEMY 198, 28, 0
			MOV R8, 022H	;LAST WALL
			SPAWNENEMY 229, 108, 0
		S1E13:
			CMP RAX, 01DH
			JNZ S1E14
			MOV R8, 01CH	;UP MISSLE
			SPAWNENEMY 214, 94, 0
			JMP ENDCOLUMNTICKEVENTS
		S1E14:
			CMP RAX, 01EH
			JNZ S1E15
			MOV R8, 025H	;TANKER
			SPAWNENEMY 220, 26, 0
			JMP ENDCOLUMNTICKEVENTS
		S1E15:
			CMP RAX, 01FH
			JNZ S1E16
			MOV R8, 01CH	;UP MISSLE
			SPAWNENEMY 230, 74, 0
			JMP ENDCOLUMNTICKEVENTS
		S1E16:
			CMP RAX, 020H
			JNZ S1E17
			MOV R8, 025H	;TANKER
			SPAWNENEMY 232, 110, 0
			JMP ENDCOLUMNTICKEVENTS
		S1E17:
			CMP RAX, 021H
			JNZ S1E18
			MOV R8, 01CH	;UP MISSLE
			SPAWNENEMY 230, 52, 0
			MOV R8, 01CH	;UP MISSLE
			SPAWNENEMY 238, 80, 0
			JMP ENDCOLUMNTICKEVENTS
		S1E18:
			CMP RAX, 022H
			JNZ S1E19
			MOV R8, 024H	;SIDE TURRENT
			SPAWNENEMY 236, 112, 0
			JMP ENDCOLUMNTICKEVENTS
		S1E19:
			CMP RAX, 023H
			JNZ S1E20
			MOV R8, 025H	;TANKER
			SPAWNENEMY 229, 48, 0
			JMP ENDCOLUMNTICKEVENTS
		S1E20:
			CMP RAX, 026H
			JNZ S1E21
			MOV R8, 023H	;SPAWN FRONT FACING TURRENT
			SPAWNENEMY 231, 86, 0
			JMP ENDCOLUMNTICKEVENTS
		S1E21:
			CMP RAX, 027H
			JNZ S1E22
			MOV R8, 01CH	;UP MISSLE
			SPAWNENEMY 230, 22, 0
			JMP ENDCOLUMNTICKEVENTS
		S1E22:
			CMP RAX, 028H
			JNZ S1E23
			MOV R8, 023H	;SPAWN FRONT FACING TURRENT
			SPAWNENEMY 235, 115, 0
			JMP ENDCOLUMNTICKEVENTS
		S1E23:
			CMP RAX, 029H
			JNZ S1E24
			MOV R8, 025H	;TANKER
			SPAWNENEMY 229, 20, 0
			JMP ENDCOLUMNTICKEVENTS
		S1E24:
			CMP RAX, 02BH
			JNZ S1E25
			MOV R8, 01CH	;UP MISSLE
			SPAWNENEMY 230, 115, 0
			JMP ENDCOLUMNTICKEVENTS
		S1E25:
			CMP RAX, 02DH
			JNZ S1E26
			MOV R8, 01CH	;UP MISSLE
			SPAWNENEMY 222, 79, 0
			MOV R8, 022H	;WALL
			SPAWNENEMY 229, 11, 0
			JMP ENDCOLUMNTICKEVENTS
		S1E26:
			CMP RAX, 02EH
			JNZ S1E27
			MOV R8, 022H	;WALL
			SPAWNENEMY 237, 31, 0
			JMP ENDCOLUMNTICKEVENTS
		S1E27:
			CMP RAX, 030H
			JNZ S1E28
			MOV R8, 021H	;LAST WALL
			SPAWNENEMY 229, 60, 0
			JMP ENDCOLUMNTICKEVENTS
		S1E28:
			CMP RAX, 032H
			JNZ S1E29
			MOV R8, 023H	;SPAWN FRONT FACING TURRENT
			SPAWNENEMY 227, 107, 0
			MOV R8, 01CH	;UP MISSLE
			SPAWNENEMY 221, 80, 0
			MOV R8, 01CH	;UP MISSLE
			SPAWNENEMY 221, 40, 0
			JMP ENDCOLUMNTICKEVENTS
		S1E29:
			CMP RAX, 035H
			JNZ S1E30
			MOV R8, 01CH	;UP MISSLE
			SPAWNENEMY 230, 123, 0
			JMP ENDCOLUMNTICKEVENTS
		S1E30:
			CMP RAX, 037H
			JNZ S1E31
			MOV R8, 023H	;SPAWN FRONT FACING TURRENT
			SPAWNENEMY 218, 25, 0
			JMP ENDCOLUMNTICKEVENTS
		S1E31:
			CMP RAX, 03AH
			JNZ S1E32
			MOV R8, 01CH	;UP MISSLE
			SPAWNENEMY 237, 97, 0
			JMP ENDCOLUMNTICKEVENTS
		S1E32:
			CMP RAX, 03CH
			JNZ S1E33
			MOV R8, 019H	;GROUND PLANE
			SPAWNENEMY 233, 105, 0
			MOV R8, 019H	;GROUND PLANE
			SPAWNENEMY 224, 55, 0
			MOV R8, 01CH	;UP MISSLE
			SPAWNENEMY 238, 69, 0
			JMP ENDCOLUMNTICKEVENTS
		S1E33:
			CMP RAX, 03DH
			JNZ S1E34
			MOV R8, 01CH	;UP MISSLE
			SPAWNENEMY 237, 70, 0
			JMP ENDCOLUMNTICKEVENTS
		S1E34:
			CMP RAX, 040H
			JNZ S1E35
			MOV R8, 025H	;TANKER
			SPAWNENEMY 229, 100, 0
			JMP ENDCOLUMNTICKEVENTS
		S1E35:
			CMP RAX, 042H
			JNZ S1E36
			MOV R8, 025H	;TANKER
			SPAWNENEMY 237, 68, 0
			JMP ENDCOLUMNTICKEVENTS
		S1E36:
			CMP RAX, 045H
			JNZ S1E37
			MOV R8, 023H	;SPAWN FRONT FACING TURRENT
			SPAWNENEMY 217, 130, 0
			JMP ENDCOLUMNTICKEVENTS
		S1E37:
			CMP RAX, 046H
			JNZ S1E38
			MOV R8, 026H	;SPAWN DISH
			SPAWNENEMY 229, 45, 0
			MOV R8, 023H	;SPAWN FRONT FACING TURRENT
			SPAWNENEMY 225, 21, 0
			JMP ENDCOLUMNTICKEVENTS
		S1E38:
			CMP RAX, 048H
			JNZ S1E39
			MOV R8, 01CH	;UP MISSLE
			SPAWNENEMY 238, 20, 0
			JMP ENDCOLUMNTICKEVENTS
		S1E39:
			CMP RAX, 049H
			JNZ S1E40
			MOV R8, 01CH	;UP MISSLE
			SPAWNENEMY 230, 73, 0
			JMP ENDCOLUMNTICKEVENTS
		S1E40:
			CMP RAX, 04AH
			JNZ S1E41
			MOV R8, 01CH	;UP MISSLE
			SPAWNENEMY 238, 70, 0
			MOV R8, 01CH	;UP MISSLE
			SPAWNENEMY 238, 100, 0
			JMP ENDCOLUMNTICKEVENTS
		S1E41:
			CMP RAX, 04CH
			JNZ S1E42
			MOV R8, 025H	;TANKER
			SPAWNENEMY 238, 68, 0
			MOV R8, 023H	;SPAWN FRONT FACING TURRENT
			SPAWNENEMY 233, 20, 0
			JMP ENDCOLUMNTICKEVENTS
		S1E42:
			CMP RAX, 04EH
			JNZ S1E43
			MOV R8, 01CH	;UP MISSLE
			SPAWNENEMY 237, 43, 0
			JMP ENDCOLUMNTICKEVENTS
		S1E43:
			CMP RAX, 050H
			JNZ S1E44
			MOV R8, 019H	;GROUND PLANE
			SPAWNENEMY 231, 51, 0
			JMP ENDCOLUMNTICKEVENTS
		S1E44:
			CMP RAX, 051H
			JNZ S1E45
			MOV R8, 01CH	;UP MISSLE
			SPAWNENEMY 237, 70, 0
			JMP ENDCOLUMNTICKEVENTS
		S1E45:
			CMP RAX, 052H
			JNZ S1E46
			MOV R8, 01CH	;UP MISSLE
			SPAWNENEMY 228, 102, 0
			JMP ENDCOLUMNTICKEVENTS
		S1E46:
			CMP RAX, 053H
			JNZ S1E47
			MOV R8, 019H	;GROUND PLANE
			SPAWNENEMY 235, 25, 0
			JMP ENDCOLUMNTICKEVENTS
		S1E47:
			CMP RAX, 055H
			JNZ S1E48
			MOV R8, 023H	;SPAWN FRONT FACING TURRENT
			SPAWNENEMY 233, 112, 0
			MOV R8, 019H	;GROUND PLANE
			SPAWNENEMY 228, 52, 0
			JMP ENDCOLUMNTICKEVENTS
		S1E48:
		S1E49:
			CMP RAX, 05AH
			JNZ S1E50
			MOV R8, 025H	;TANKER
			SPAWNENEMY 229, 92, 0
			JMP ENDCOLUMNTICKEVENTS
		S1E50:
			CMP RAX, 05BH
			JNZ S1E51
			MOV R8, 01CH	;UP MISSLE
			SPAWNENEMY 230, 38, 0
			JMP ENDCOLUMNTICKEVENTS
		S1E51:
			CMP RAX, 05DH
			JNZ S1E52
			MOV R8, 01CH	;UP MISSLE
			SPAWNENEMY 229, 92, 0
			JMP ENDCOLUMNTICKEVENTS
		S1E52:
			CMP RAX, 05FH
			JNZ S1E53
			MOV R8, 025H	;TANKER
			SPAWNENEMY 225, 82, 0
			JMP ENDCOLUMNTICKEVENTS
		S1E53:
			CMP RAX, 061H
			JNZ S1E54
			MOV R8, 026H	;SPAWN DISH
			SPAWNENEMY 221, 113, 0
			JMP ENDCOLUMNTICKEVENTS
		S1E54:
			CMP RAX, 065H
			JNZ S1E55
			MOV R8, 01H	;SPAWN ENTRY WALLS
			SPAWNENEMY 50, 0, 0
			JMP ENDCOLUMNTICKEVENTS
		S1E55:
			CMP RAX, 069H
			JNZ S1E56
			MOV HIDESHADOW, 01H	;TURN SHADOW OFF
			JMP ENDCOLUMNTICKEVENTS
		S1E56:
			CMP RAX, 06FH
			JNZ ENDCOLUMNTICKEVENTS
			MOV HIDESHADOW, 00H	;TURN SHADOW BACK ON
			INC STAGE	;MOVE TO NEXT STAGE
		JMP ENDCOLUMNTICKEVENTS
	
	

	ENDCOLUMNTICKEVENTS:
ENDM


MOVEBACKGROUND MACRO
	;MOVE BACKGROUND LAYER 0 OVER 16, DOWN 8
		;SHIFT LAYER ROWS TO DO SO
	;THEN AFTER THE SHIFT IS FINISHED:
		;COPY ALL ROWS DOWN 1, AND OVER 2 TILES
		;RESET SHIFTS
		;LOAD IN NEW EDGE TILES
	LOCAL JUSTXSCROLL
	LOCAL MOVEDOWN1SIDE2
	LOCAL PUSHSCROLL
	LOCAL ENEMIESBACKGROUNDSCROLL
	LOCAL NEXTEBGSCROLL
	LOCAL ENDMOVEBACKGROUND
	
	;CHECK STAGE
	MOV RAX, STAGE
	CMP RAX, 02H
	JA ENDMOVEBACKGROUND
	
	MOV RAX, PAUSESCROLL
	CMP RAX, 00H
	JNZ ENDMOVEBACKGROUND
	
	
	;CHECK FRAMERULE
	INC SCROLLFRAMERULEC
	MOV RAX, SCROLLFRAMERULEC
	CMP RAX, SCROLLFRAMERULE
	JNZ ENDMOVEBACKGROUND
	XOR RAX, RAX
	MOV SCROLLFRAMERULEC, RAX
	
	
	;TESTING TO SHOW OFF:
	INC SCROLLTIMER
	MOV RAX, SCROLLTIMER
		TEST RAX, 01H
		JNZ JUSTXSCROLL
	INC SCROLLY
	JUSTXSCROLL:
	INC SCROLLX
	
	
	MOV RAX, SCROLLX
	CMP RAX,  010H
	JNZ PUSHSCROLL
		;INCREASE COLUMN TICK COUNT
		INC COLUMNTICK
		COLUMNTICKEVENTS
		;RETILE TILE MAP 0
		LEA RBX, QWORD PTR [TILEMAP0]
		MOV R8, 07BEH	;SOURCE OFFSET FROM RBX
		MOV RDX, 07FAH	;DESTINATION OFFSET FROM RBX
		XOR R9, R9
		MOV RCX, 01FH
	MOVEDOWN1SIDE2:
		MOV AX, WORD PTR [RBX + R8]
		MOV WORD PTR [RBX + RDX], AX
		DEC R8
		DEC R8
		DEC RDX
		DEC RDX
		INC R9
		CMP R9, 01EH
		JNZ MOVEDOWN1SIDE2
			;ELSE DECREASE R8 & RDX BY FOUR
			SUB R8, 04H
			SUB RDX, 04H
			XOR R9, R9
			LOOP MOVEDOWN1SIDE2
	
		;RESET SCROLL
		XOR RAX, RAX
		MOV SCROLLX, RAX
		MOV SCROLLY, RAX
		;LOAD NEW SECTION:
		LOADINNEXTSECTIONOFMAP
	
	PUSHSCROLL:
	MOV RAX, 0100H
	SUB RAX, SCROLLX
	MOV BYTE PTR [TM0XOFFSET], AL
	MOV RAX, SCROLLY
	MOV BYTE PTR [TM0YOFFSET], AL
	
	;COMPARE TO LAST SCROLL:
	MOV RAX, SCROLLX
	CMP RAX, LASTSCROLLX
	JZ ENDMOVEBACKGROUND	;IF SAME, NO NEED TO UPDATE ENEMIES
		;ELSE MOVE ENEMIES ALONG WITH THE BACKGROUND
		MOV RCX, SCROLLY
		XOR RCX, LASTSCROOLY
		AND RCX, 01H	;INCREASE Y IF NOT THE SAME
		MOV RDX, 01H
		SHL RDX, CL		;2 IF MOVED Y, 1 IF DIDN'T MOVE Y (USED FOR FASTER SPEED OBJECTS)	
		
		MOV R8, RDX
		MOV R9, 01H		;ALWAYS DECREASE X
		MOV RCX, NUMBEROFENEMY
		LEA RBX, QWORD PTR [ENEMY]
		ENEMIESBACKGROUNDSCROLL:
			PUSH RCX
			MOV AL, BYTE PTR [RBX]
			CMP AL, 00H
			JZ NEXTEBGSCROLL	;NOT ACTIVE
			TEST AL, 02H	;NON-SCROLL EFFECT BIT
			JNZ NEXTEBGSCROLL
				;FOR FASTER SCROLL:
				MOV R10, QWORD PTR [RBX]	;MODE
				AND R10, 080H	;EXTRA SPEED BIT
				SHR R10, 06H				
				;SCROLL X AND Y
					MOV RDX, R8
					MOV RCX, R10
					SHL RDX, CL	;MULTIPLY NUMBER OF TIMES IN R10 FOR SPEED (DEFUALT IS 0)
					SHR RDX, 01H	;DIVIDE BY TWO 
				MOV AL, BYTE PTR [RBX + 06H]	;Y
				ADD AL, DL
				MOV BYTE PTR [RBX + 06H], AL
				MOV AL, BYTE PTR [RBX + 04H]	;X
					MOV RDX, R9
					SHL RDX, CL
				SUB AL, DL	;ALWAYS DECREASE
				MOV BYTE PTR [RBX + 04H], AL
				;DESPAWN WHEN X = 240
				CMP AL, 0F0H
				JB NEXTEBGSCROLL
					;DESPAWN
					XOR RAX, RAX
					MOV WORD PTR [RBX], AX
			NEXTEBGSCROLL:
			POP RCX
			ADD RBX, ENEMYOBJSIZE
			LOOP ENEMIESBACKGROUNDSCROLL
	
		;AND MOVE MODE 2 BOLTS
		MOV RDX, SCROLLY
		XOR RDX, LASTSCROOLY
		AND RDX, 01H	;INCREASE Y IF NOT THE SAME
		MOV RCX, 08H
		LEA RBX, QWORD PTR [BOLTS]
		BOLTSBACKGROUNDSCROLL:
			MOV AL, BYTE PTR [RBX]
			CMP AL, 02H
			JNZ NEXTBBGSCROLL	;ONLY MODE 2 BOLTS
				;SCROLL X AND Y
				MOV AL, BYTE PTR [RBX + 06H]	;Y
				ADD AL, DL
				MOV BYTE PTR [RBX + 06H], AL
				MOV AL, BYTE PTR [RBX + 04H]	;X
				DEC AL	;ALWAYS DECREASE
				MOV BYTE PTR [RBX + 04H], AL
				;DESPAWN WHEN X = 240
				CMP AL, 0F0H
				JNZ NEXTBBGSCROLL
					;DESPAWN
					XOR AL, AL
					MOV BYTE PTR [RBX], AL
			NEXTBBGSCROLL:
			ADD RBX, ENEMYOBJSIZE
			LOOP BOLTSBACKGROUNDSCROLL
	
	ENDMOVEBACKGROUND:
	;STORE LAST SCROLL
	MOV RAX, SCROLLX
	MOV LASTSCROLLX, RAX
	MOV RAX, SCROLLY
	MOV LASTSCROOLY, RAX
ENDM

GAMELOGIC MACRO	
	MOV RAX, HIT
	CMP RAX, 00H
	JZ NOTHIT
		MOV AL, BYTE PTR [SPRITES + 02H]
		CMP AL, 020H
		JA AFTERSETREDSPRITE
			MOV BYTE PTR [SPRITES + 02H], 03FH
		AFTERSETREDSPRITE:
		;SET MODE TO HIT
		MOV RAX, 0FFH	;DEATH MODE
		MOV STAGE, RAX
		INC EXPLODEDELAYTIMER
		MOV RAX, EXPLODEDELAYTIMER
		CMP RAX, 040H
		JB AFTERLOGIC
		SHIPEXPLODE
		JMP AFTERLOGIC
	NOTHIT:
	
		MOVESHIP
		MOVEBACKGROUND
		ENEMYLOGIC
		CHECKHITBOXES
	
	AFTERLOGIC:
	
	MOV RAX, WINTIMER
	CMP RAX, 00H
	JZ AFTERWT
		INC WINTIMER
		MOV RAX, WINTIMER
		CMP RAX, 0C0H
		JNZ AFTERWT
			RESETTITLE	
	AFTERWT:
	MOV RAX, RESET
	CMP RAX, 00H
	JZ NORESET
		RESETGAME
	NORESET:
ENDM

RENDERSPRITE MACRO
    LOCAL AFTERPLOTSPRITEPIXEL
    LOCAL POSTTILESSELECTED
    LOCAL SPRITEPIXELLOOP
    LOCAL NOTNEXTPIXELYET2
    
    SHR RAX, 10H
    XOR RBX, RBX
    MOV BX, AX
    SHL RBX, 0CH
    
    LEA RDX, QWORD PTR [spriteTiles]
    CMP SPRITEVERSION, 00H
    JZ POSTTILESSELECTED
        LEA RDX, QWORD PTR [spriteTiles2]
POSTTILESSELECTED:
    ADD RBX, RDX
    LEA RDX, QWORD PTR [OUTPUTFBUFFER]
    SHR RAX, 10H
    XOR R8, R8
    XOR R9, R9
    MOV R8, RAX
    AND R8, 0FFH
    SHL R8, 02H
    MOV R9, RAX
    SHR R9, 06H
    AND R9, 03FC00H
    ADD RDX, R8
    ADD RDX, R9
    MOV RCX, 20H
    XOR R8, R8
SPRITEPIXELLOOP:
    MOV EAX, DWORD PTR [RBX]
        CMP EAX, 00H
        JZ AFTERPLOTSPRITEPIXEL
    MOV DWORD PTR [RDX], EAX
AFTERPLOTSPRITEPIXEL:
    ADD RBX, 04H
    ADD RDX, 04H
    INC R8
    TEST R8, 01FH
    JNZ SPRITEPIXELLOOP
        ADD RDX, 0380H
        XOR R8, R8
    LOOP SPRITEPIXELLOOP
ENDM

RENDERGRAPHICS MACRO
    LOCAL ENEMIESTOSPRITES
    LOCAL NEXTENEMYSPRITE
    LOCAL BOLTTOSPRITES
    LOCAL NEXTBOLTSPRITE
    LOCAL RENDERTILEMAP0
    LOCAL RENDERTILEMAP1
    LOCAL AFTERTM1TILE
    LOCAL RESETUPSCALEVALLOOP
    LOCAL SENDTOSCREEN
    LOCAL AMPLIFYLOOP
    LOCAL AFTERSENDTOSCREEN
    LOCAL HARDWAREACCEL
    LOCAL RENDERSPRITELOOP
    LOCAL SPRITELOOPTAIL
    LOCAL SKIPRESET
    
    ; RENDER BOLTS TO SPRITES
    LEA RBX, QWORD PTR [BOLTS]
    LEA RDX, QWORD PTR [SPRITES]
    ADD RDX, 080H
    MOV RCX, 08H
BOLTTOSPRITES:
    XOR RAX, RAX
    MOV [RDX], RAX
    MOV AL, BYTE PTR [RBX]
    CMP AL, 00H
    JZ NEXTBOLTSPRITE
        MOV RAX, [RBX]
        MOV [RDX], RAX
NEXTBOLTSPRITE:
    ADD RBX, BOLTOBJSIZE
    ADD RDX, 08H
    LOOP BOLTTOSPRITES
    
    ; RENDER ENEMIES TO SPRITES
    LEA RBX, QWORD PTR [ENEMY]
    MOV RCX, NUMBEROFENEMY
ENEMIESTOSPRITES:
    XOR RAX, RAX
    MOV [RDX], RAX
    MOV AL, BYTE PTR [RBX]
    CMP AL, 00H
    JZ NEXTENEMYSPRITE
    TEST AL, 04H
    JNZ NEXTENEMYSPRITE
        MOV RAX, [RBX]
        MOV [RDX], RAX
NEXTENEMYSPRITE:
    ADD RBX, ENEMYOBJSIZE
    ADD RDX, 08H
    LOOP ENEMIESTOSPRITES
    
    ; RENDER TILE MAP 0
    XOR RBX, RBX
    LEA RDX, TILEMAP0
RENDERTILEMAP0:
    XOR RAX, RAX
    MOV AX, WORD PTR [RDX + RBX]
        PUSH RBX
        PUSH RDX
        SHR RBX, 01H
    RENDERTILE 00H
        POP RDX
        POP RBX
    INC RBX
    INC RBX
    CMP RBX, 0800H
    JNZ RENDERTILEMAP0
    
    ; RENDER SPRITES BACK TO FRONT
    LEA RBX, QWORD PTR [SPRITES]
    ADD RBX, 03F8H
    MOV RCX, 00H
RENDERSPRITELOOP:
    MOV RAX, QWORD PTR [RBX]
    CMP AL, 00H
    JZ SPRITELOOPTAIL
        PUSH RBX
        PUSH RCX
        RENDERSPRITE
        POP RCX
        POP RBX
SPRITELOOPTAIL:
    SUB RBX, 08H
    INC RCX
    CMP RCX, 080H
    JNZ RENDERSPRITELOOP

    ; RENDER TILE MAP 1
    XOR RBX, RBX
    LEA R8, TILEMAP1
RENDERTILEMAP1:
    XOR RAX, RAX
    MOV AX, WORD PTR [R8 + RBX]
    CMP AX, 00H
    JZ AFTERTM1TILE
        PUSH RBX
        PUSH R8
        SHR RBX, 01H
    RENDERTILE 01H
        POP R8
        POP RBX
AFTERTM1TILE:
    INC RBX
    INC RBX
    CMP RBX, 0800H
    JNZ RENDERTILEMAP1

    ; OUTPUT GRAPHICS TO SCREEN
    MOV RAX, UPSCALE_MODE
    CMP RAX, 00H
    JZ HARDWAREACCEL
        LEA RDX, QWORD PTR [OUTPUTFBUFFER]
        BLTBUFF 0, 0, 512, 384, 256, 256
    JMP AFTERSENDTOSCREEN

HARDWAREACCEL:
    MOV RCX, 020H
    MOV RAX, 00H
    LEA RBX, QWORD PTR [UPSCALEDROW]
RESETUPSCALEVALLOOP:
    MOV QWORD PTR [RBX], RAX
    ADD RBX, 08H
    LOOP RESETUPSCALEVALLOOP
    MOV QWORD PTR [UPSCALEDCOUNT], RAX

    MOV RCX, MPServices
    LEA RDX, [PARALLELRENDERTOSCREEN]
    MOV R8, 00H
    MOV R9, 00H
    SUB RSP, 8
    PUSH QWORD PTR [FAILEDCPULIST]
    PUSH 00H
    PUSH 00H
    CALL StartupAllAPs
    
    MOV RAX, QWORD PTR [UPSCALEDCOUNT]
    OUTPUT64BITNUMBER 00H
    
    MOV RAX, QWORD PTR [UPSCALEDCOUNT]
    CMP RAX, 00H
    JNZ SKIPRESET
        INC UPSCALE_MODE
        RESETTITLE
SKIPRESET:
    
    MOV RDX, UPSCALEDBUFFER
    BLTBUFF 0, 0, 128, 0, 1024, 1024
    
AFTERSENDTOSCREEN:
ENDM

GRAPHICSINIT MACRO
    LOCAL TILEMAPLOOP1
    LOCAL TILEMAPLOOP2
    LOCAL TITLECARDLOOP
    LOCAL TILEMAPTOPLOOP
    
    LEA RDX, QWORD PTR [COLORBLACK]
    BLTRECT 0, 0, 0, 0, 1280, 1024
    
    LEA RBX, QWORD PTR [TILEMAP0]
    ADD RBX, 05EH
    LEA RDX, QWORD PTR [tilemap]
    XOR R8, R8
    MOV RCX, 014H
TILEMAPLOOP1:
    MOV AX, WORD PTR [RDX]
    MOV WORD PTR [RBX], AX
    INC RBX
    INC RBX
    INC RDX
    INC RDX
    INC R8
    CMP R8, 0FH
    JNZ TILEMAPLOOP1
        XOR R8, R8
        ADD RBX, 022H
    LOOP TILEMAPLOOP1
    
    LEA RBX, QWORD PTR [TILEMAP1]
    MOV RCX, 020H
    MOV RAX, 05EDH
    XOR R8, R8
TILEMAPTOPLOOP:
    MOV WORD PTR [RBX + R8], AX
    INC R8
    INC R8
    LOOP TILEMAPTOPLOOP
    
    MOV RDX, RBX
    ADD RDX, 03CH
    XOR R8, R8
    MOV RCX, 00H
    MOV RAX, 05EDH
TILEMAPLOOP2:
    MOV WORD PTR [RBX + R8], AX
    MOV WORD PTR [RDX + R8], AX
    INC R8
    INC R8
    INC RCX
    TEST RCX, 01H
    JNZ TILEMAPLOOP2
        ADD R8, 03CH
    CMP RCX, 040H
    JNZ TILEMAPLOOP2
    LOADINNEXTSECTIONOFMAP
    
    MOV RCX, 12H
    LEA RDX, QWORD PTR [TITLECARD]
    LEA RBX, QWORD PTR [TILEMAP1]
    ADD RBX, 018H
TITLECARDLOOP:
    MOV AX, WORD PTR [RDX]
    MOV WORD PTR [RBX], AX
    INC RBX
    INC RBX
    INC RDX
    INC RDX
    LOOP TITLECARDLOOP
    
    LEA RBX, QWORD PTR [TILEMAP1]
    ADD RBX, 0204H
    MOV RAX, 064DH
    MOV WORD PTR [RBX], AX
    ADD RBX, 0140H
    MOV RAX, 0643H
    MOV WORD PTR [RBX], AX
    
    LEA RBX, QWORD PTR [SPRITES]
    MOV RAX, 046000C00000001H
    MOV QWORD PTR [RBX], RAX
    
    LEA RBX, QWORD PTR [SPRITES + 08H]
    MOV RAX, 0DC00B0003B0001H
    MOV QWORD PTR [RBX], RAX
    
    LEA RBX, QWORD PTR [SPRITES + 10H]
    MOV RAX, 0E000B0003A0001H
    MOV QWORD PTR [RBX], RAX
    
    LEA RBX, QWORD PTR [SPRITES + 18H]
    MOV RAX, 0E000D0003C0001H
    MOV QWORD PTR [RBX], RAX
    
    LEA RBX, QWORD PTR [SPRITES + 03F8H]
    MOV RAX, 0000000000C0001H
    MOV QWORD PTR [RBX], RAX
    
    MOV AL, 0FFH
    MOV BYTE PTR [SHIPFUEL], AL
ENDM

ENDIF
