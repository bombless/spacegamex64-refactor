; MACROS_GAME.INC - Game logic macros

IFNDEF MACROS_GAME_INC
MACROS_GAME_INC EQU 1


;GAME LOGIC MACROS
RESETGAME MACRO
	LOCAL CLEARTILEMAPS
	LOCAL CLEARBUFF
	LOCAL CLEARBOLTS
	LOCAL CLEARENEMIES
	;RESET ALL VARIABLES
	MOV STAGE, 00H
	MOV SHIPX, 00H
	MOV SHIPY, 00H
	MOV SHIPTILTY, 00H
	XOR RAX, RAX
	MOV BYTE PTR [SHIPHITBOX], AL
	MOV BYTE PTR [SHIPHITBOX + 01H], AL
	MOV BYTE PTR [SHIPHITBOX + 02H], AL
	MOV BYTE PTR [SHIPHITBOX + 03H], AL
	MOV BYTE PTR [SHIPALT], AL
	MOV BYTE PTR [SHIPFUEL], AL
	MOV SCROLLTIMER, 00H
	MOV SCROLLX, 00H
	MOV SCROLLY, 00H
	MOV LASTSCROLLX, 00H
	MOV LASTSCROOLY, 00H
	MOV GAMEMAPOFFSET, 0258H
	MOV COLUMNTICK, 00H
	MOV HIDESHADOW, 00H
	MOV HIT, 00H
	MOV NOFUEL, 00H
	MOV PAUSESCROLL, 00H
	MOV EXPLODETIMER, 00H
	MOV RESET, 00H
	MOV EXPLODEDELAYTIMER, 00H
	MOV WINTIMER, 00H


	MOV BYTE PTR [TM0XOFFSET], 00H
	MOV BYTE PTR [TM0YOFFSET], 00H
	MOV BYTE PTR [TM1XOFFSET], 00H
	MOV BYTE PTR [TM1YOFFSET], 00H
	;CLEAR TILEMAPS
	XOR RAX, RAX
	MOV RCX, 0400H
	LEA RDX, QWORD PTR [TILEMAP0]
	LEA RBX, QWORD PTR [TILEMAP1]
	CLEARTILEMAPS:
		MOV WORD PTR [RDX], AX
		MOV WORD PTR [RBX], AX
		ADD RDX, 02H
		ADD RBX, 02H
		LOOP CLEARTILEMAPS

	;FRAMERULES:
	MOV MOVEMENTFRAMERULEC, 00H
	MOV SCROLLFRAMERULEC, 00H
	MOV FUELFRAMERULEC, 00H	
	MOV ELOGICFRAMERULEC, 00H
	MOV EXPLODEFRAMERULEC, 00H
	
	;CLEAR BUFFER
	MOV RCX, 010000H
	LEA RDX, QWORD PTR [OUTPUTFBUFFER]
	XOR RAX, RAX
	CLEARBUFF:
		MOV DWORD PTR [RDX], EAX
		ADD RDX, 04H
		LOOP CLEARBUFF
	
	;CLEAR BOLTS:
	MOV RCX, 08H
	LEA RDX, QWORD PTR [BOLTS]
	CLEARBOLTS:
		MOV [RDX], RAX
		ADD RDX, BOLTOBJSIZE
		LOOP CLEARBOLTS
	
	;CLEAR ENEMIES:
	MOV RCX, NUMBEROFENEMY
	LEA RDX, QWORD PTR [ENEMY]
	CLEARENEMIES:
		MOV [RDX], RAX
		ADD RDX, ENEMYOBJSIZE
		LOOP CLEARENEMIES
	
	;INIT GRAPHICS
	GRAPHICSINIT
	
	;UNPAUSE
	MOV PAUSEGAME, 00H
ENDM


FIREBOLT MACRO
	LOCAL ENDFIREBOLT
	LOCAL CHECKBOLT
	LOCAL NEXTBOLTCHECK
	LOCAL FIREINTHEHOLE
	;LOCATE EMPTY BOLT SLOT
	LEA RBX, QWORD PTR [BOLTS]
	MOV RCX, 00H
	CHECKBOLT:
		MOV AL, BYTE PTR [RBX]
		CMP AL, 00H
		JZ FIREINTHEHOLE	
	NEXTBOLTCHECK:
		ADD RBX, BOLTOBJSIZE
		LOOP CHECKBOLT
		JMP ENDFIREBOLT	;NO BOLT SLOTS AVAILABLE
	
	FIREINTHEHOLE:	;BOLT SLOT FOUND, FIRE AWAY
		INC BYTE PTR [RBX]	;TURN ON
		MOV AL, 0DH
		MOV BYTE PTR [RBX + 02H], AL	;SPRITE
		MOV RAX, SHIPX
		ADD RAX, SHIPORGINX
		ADD RAX, 010H
		MOV BYTE PTR [RBX + 04H], AL	;X
		MOV RAX, SHIPY
		SHR RAX, 01H		
		ADD RAX, SHIPORGINY
		ADD RAX, SHIPTILTY
		SUB RAX, 07H
		MOV BYTE PTR [RBX + 06H], AL	;Y
		
		MOV BYTE PTR [RBX + 08H], 08H	;X
		MOV BYTE PTR [RBX + 09H], 0BH	;Y
		MOV BYTE PTR [RBX + 0AH], 010H	;WIDTH
		MOV BYTE PTR [RBX + 0BH], 08H	;HEIGHT
		MOV AL, SHIPALT
		MOV BYTE PTR [RBX + 0CH], AL	;ALTITUDE
		MOV BYTE PTR [RBX + 0DH], 00H	;TIMER
		MOV BOLTCOOLDOWN, BOLTCOOLDOWNFRAMES
	
	ENDFIREBOLT:
ENDM


BOLTLOGIC MACRO
	;MOVE BOLTS AROUND, SET HIT BOXES
;BOLTOBJ STRUCT
;	MODE DW ?	;0 IF INACTIVE
;	SPRITE DW ?
;	X DW ?
;	Y DW ?
;	HITBOXX DB ?	;X & Y ARE OFFSET FROM TOP LEFT CORNER
;	HITBOXY DB ?
;	HITBOXW DB ?
;	HITBOXH DB ?
;	ALT		DB ?	;ALTITUDE
;BOLTOBJ ENDS	
	LOCAL DEADBOLT
	LOCAL MOVEBOLT

	;LOCATE EMPTY BOLT SLOT
	LEA RBX, QWORD PTR [BOLTS]
	MOV RCX, 08H
	CHECKBOLT:
		MOV AL, BYTE PTR [RBX]
		CMP AL, 00H
		JZ NEXTBOLTCHECK
		;BOLT IS ACTIVE MODE 1, MOVE
		CMP AL, 01H
		JZ MOVEBOLT
			;ELSE IS MODE 2, INCREASE SPRITES ACCORDING TO TIMER
			MOV AL, BYTE PTR [RBX + 0DH]	;TIMER
			INC AL
			CMP AL, 010	;MAX TIME
			JA DEADBOLT
			SHR AL, 03H	;/8
			ADD AL, 031H
			MOV BYTE PTR [RBX + 02H], AL	;SPRITE
			;INCREASE TIMER
			INC BYTE PTR [RBX + 0DH]	;TIMER
			JMP NEXTBOLTCHECK
		MOVEBOLT:
		MOV AL, BYTE PTR [RBX + 06H]	;Y
			DEC AL
			CMP AL, 0FFH	;DON'T WRAP AROUND SCREEN
			JZ DEADBOLT
		MOV BYTE PTR [RBX + 06H], AL
		MOV AL, BYTE PTR [RBX + 04H]	;X
		INC AL
		INC AL
		MOV BYTE PTR [RBX + 04H], AL
		CMP AL, 0F0H
		JB NEXTBOLTCHECK
			DEADBOLT:	;HIT THE EDGE OF THE SCREEN, DISABLE
			XOR RAX, RAX
			MOV BYTE PTR [RBX], AL
		
	NEXTBOLTCHECK:
		ADD RBX, BOLTOBJSIZE
		LOOP CHECKBOLT
ENDM



MOVESHIP MACRO
	LOCAL STARTMOVESHIP
	LOCAL AFTERSHIPLEFT
	LOCAL AFTERSHIPRIGHT
	LOCAL AFTERSHIPUP
	LOCAL AFTERSHIPDOWN
	LOCAL AFTERBOLTCHECK
	LOCAL AFTERBOLTS
	LOCAL COMPASS1
	LOCAL COMPASS2
	LOCAL COMPASS3
	LOCAL COMPASS4
	LOCAL COMPASS5
	LOCAL COMPASS6
	LOCAL COMPASS7
	LOCAL COMPASS8
	LOCAL SETSPRITEBUTTON
	LOCAL CALCALTITUDESPRITE
	LOCAL FULLALTSPRITE
	LOCAL DRAWFUELSPRITES
	LOCAL DEADSHIPFROMNOFUEL
	LOCAL SETFUELSPRITES
	LOCAL NEXTFUELSPRITE
	LOCAL SETALTSPRITE
	LOCAL ENDMOVESHIP
	;CHECK STAGE
	MOV RAX, STAGE
	CMP RAX, 02H
	JBE STARTMOVESHIP
		;CHANGE SPRITE TO RED SHIP:
		MOV AL, 03FH
		MOV BYTE PTR [SPRITES + 02H], AL
	JMP ENDMOVESHIP
	
	;COMBINE KEYBOARD AND MOUSE MOVEMENT INTO ONE BYTE:
	STARTMOVESHIP:
	MOV AL, BYTE PTR [PRESSEDLEFT]
	OR AL, BYTE PTR [POINTERLEFT]
	MOV BYTE PTR [COMBLEFT], AL
	MOV AL, BYTE PTR [PRESSEDRIGHT]
	OR AL, BYTE PTR [POINTERRIGHT]
	MOV BYTE PTR [COMBRIGHT], AL
	MOV AL, BYTE PTR [PRESSEDUP]
	OR AL, BYTE PTR [POINTERUP]
	MOV BYTE PTR [COMBUP], AL
	MOV AL, BYTE PTR [PRESSEDDOWN]
	OR AL, BYTE PTR [POINTERDOWN]
	MOV BYTE PTR [COMBDOWN], AL
	MOV AL, BYTE PTR [PRESSEDFIRE]
	OR AL, BYTE PTR [POINTERFIRE]
	MOV BYTE PTR [COMBFIRE], AL
	
	;CHECK MOVEMENTFRAMERULE
	INC MOVEMENTFRAMERULEC
	MOV RAX, MOVEMENTFRAMERULEC
	CMP RAX, MOVEMENTFRAMERULE
	JNZ ENDMOVESHIP
		;HIT FRAMERULE, RESET COUNTER
		XOR RAX, RAX
		MOV MOVEMENTFRAMERULEC, RAX
	
	MOV RBX, SHIPX
	MOV RDX, SHIPY
	XOR R8, R8
					;MOVE LEFT
	MOV AL, BYTE PTR [COMBLEFT]
	CMP AL, 01H
	JNZ AFTERSHIPLEFT
		CMP RBX, 00H
		JZ AFTERSHIPLEFT
		DEC RBX
		TEST RBX, 01H
		JZ AFTERSHIPLEFT
		;DECREASE Y BY 2
		DEC SHIPTILTY
	AFTERSHIPLEFT:	;MOVE RIGHT
	MOV AL, BYTE PTR [COMBRIGHT]
	CMP AL, 01H
	JNZ AFTERSHIPRIGHT
		CMP RBX, SHIPMAXX
		JZ AFTERSHIPRIGHT
		INC RBX
		TEST RBX, 01H
		JNZ AFTERSHIPRIGHT
		;INCREASE Y BY 2
		INC SHIPTILTY
	AFTERSHIPRIGHT:	;MOVE UP
	MOV AL, BYTE PTR [COMBUP]
	CMP AL, 01H
	JNZ AFTERSHIPUP
		CMP RDX, 00H
		JZ AFTERSHIPUP
		MOV R8, 04H	;GOING UP
		DEC RDX
		DEC RDX
	AFTERSHIPUP:	;MOVE DOWN
	MOV AL, BYTE PTR [COMBDOWN]
	CMP AL, 01H
	JNZ AFTERSHIPDOWN
		CMP RDX, SHIPMAXY
		JZ AFTERSHIPDOWN
		MOV R8, 08H	;GOING UP
		INC RDX
		INC RDX
	AFTERSHIPDOWN:
	MOV SHIPX, RBX
	MOV SHIPY, RDX
	;SET SHIP LOCATION IN SPRITES:
		MOV RAX, SHIPY
		SHR RAX, 01H	;DIVIDE BY TWO
		ADD RAX, SHIPORGINY
			MOV RDX, SHIPTILTY
			ADD RAX, RDX
		SHL RAX, 010H
		MOV RBX, SHIPX
		ADD RBX, SHIPORGINX
		OR RAX, RBX
		MOV DWORD PTR [SPRITES + 04H], EAX
	;SET SPRITE:
		MOV RAX, R8
		MOV BYTE PTR [SPRITES + 02H], AL
	;SET SHADOW SPRITE:
	MOV RAX, SHIPORGINY
	ADD RAX, SHIPTILTY
	ADD RAX, 03H
	MOV RDX, SHIPMAXY
	SHR RDX, 01H
	ADD RAX, RDX
	SHL RAX, 010H
	ADD RAX, SHIPX
	ADD RAX, 0FH
	MOV DWORD PTR [SPRITES + 03FCH], EAX
	MOV RAX, HIDESHADOW
	XOR RAX, 01H
	MOV BYTE PTR [SPRITES + 03F8H], AL
	
	;SET ALTITUDE SPRITES:
		MOV R8, 28
		MOV R9, 7
		MOV R10, SHIPMAXY
		SUB R10, SHIPY
		MOV RCX, 04H	
		LEA RBX, QWORD PTR [TILEMAP1]
		ADD RBX, 0304H
		XOR R11, R11
	CALCALTITUDESPRITE:
		CMP R10, R8	;COMPARE TO 28, IF GREATER OR EQUAL, IT'S A FULL SPRITE
		JAE FULLALTSPRITE
		;ELSE FIND PERCENTAGE FULL
		MOV RAX, R10
		SHL RAX, 01H
		XOR RDX, RDX
		DIV R9
		ADD RAX, 0644H
		;MOVE 28 INTO R10
		MOV R10, R8
		JMP SETALTSPRITE	
		FULLALTSPRITE:
			MOV AX, 064CH
			CMP R11, 03H
			JAE SETALTSPRITE
			INC R11
		SETALTSPRITE:
		MOV WORD PTR [RBX], AX
		SUB R10, R8
		SUB RBX, 040H
		LOOP CALCALTITUDESPRITE
			MOV RAX, R11
			MOV BYTE PTR [SHIPALT], AL

	;FUEL FRAMERULE:
		XOR RAX, RAX
		MOV AL, BYTE PTR [SHIPFUEL]
		INC FUELFRAMERULEC
		MOV RBX, FUELFRAMERULEC
		CMP RBX, FUELFRAMERULE
		JNZ SETFUELSPRITES
		XOR RBX, RBX
		MOV FUELFRAMERULEC, RBX
		CMP AL, 00H
		JZ DEADSHIPFROMNOFUEL
			;DECREASE FUEL
			DEC AL
			MOV BYTE PTR [SHIPFUEL], AL
			JMP SETFUELSPRITES
		DEADSHIPFROMNOFUEL:
			INC NOFUEL
			MOV RBX, 0FFH	;DEATH MODE
			MOV STAGE, RBX
	SETFUELSPRITES:
		SHR RAX, 02H	;/4
		MOV R8, RAX
		MOV RCX, 08H	
		LEA RBX, QWORD PTR [TILEMAP1]
		ADD RBX, 0798H
		MOV RDX, 08H	;COMPARISON GUAGE
	DRAWFUELSPRITES:
		MOV AX, 05E0H
		CMP R8, RDX		;CURRENT FUEL AGAINST INCREASING GAUGE
		JAE FULLFUELCELL
			;ELSE IS LESS THAN FULL CELL
			AND R8, 07H
			ADD RAX, R8
			MOV R8, 00H	;CLEAR FUEL FOR REST OF CELLS
		JMP NEXTFUELSPRITE
		FULLFUELCELL:
			ADD AX, 07H	;FULL CELL
	NEXTFUELSPRITE:
		MOV WORD PTR [RBX], AX	;STORE SPRITE
		ADD RDX, 08H	;INCREASE TO NEXT GUAGE
		INC RBX
		INC RBX
		LOOP DRAWFUELSPRITES
	
	;CHECK BOLT FIRE
	MOV RAX, BOLTCOOLDOWN
	CMP RAX, 00H
	JNZ AFTERBOLTCHECK
		;CHECK FIRE
		MOV AL, BYTE PTR [COMBFIRE]
		CMP AL, 01H
		JNZ AFTERBOLTCHECK
		;ELSE TRY TO FIRE BOLT:
		FIREBOLT	
	AFTERBOLTCHECK:
		BOLTLOGIC
		MOV RAX, BOLTCOOLDOWN
		CMP RAX, 00H
		JZ AFTERBOLTS
		DEC BOLTCOOLDOWN
	AFTERBOLTS:
	
	;SHOW MOVEMENT IN ARCADE JOYSTICK AND BUTTON
		;EIGHT POSSIBLE LOCATIONS IF R8 = UDLR:
		;U000, U00R, 000R, 0D0R, 0D00, 0DL0, 00L0, U0L0
		;OTHER MODES ARE POSSIBLE SINCE KEYBOARD | MOUSE INPUT, BUT THOSE RESULT IN ONLY STANDARD POSITION
	XOR RAX, RAX
	MOV AL, BYTE PTR [COMBUP]
	SHL AL, 01H
	OR AL, BYTE PTR [COMBDOWN]
	SHL AL, 01H
	OR AL, BYTE PTR [COMBLEFT]
	SHL AL, 01H
	OR AL, BYTE PTR [COMBRIGHT]
	MOV R8, RAX		;R8 LOWEST NIBBLE = UDLR
	CMP R8, 08H
	JNZ COMPASS1
		MOV EAX, 0D600B0H	;Y-6
		JMP SETSPRITEBUTTON
	COMPASS1:
	CMP R8, 09H
	JNZ COMPASS2
		MOV EAX, 0D800B4H	;Y-4, X+4
		JMP SETSPRITEBUTTON
	COMPASS2:
	CMP R8, 01H
	JNZ COMPASS3
		MOV EAX, 0DC00B6H	;X+6
		JMP SETSPRITEBUTTON
	COMPASS3:
	CMP R8, 05H
	JNZ COMPASS4
		MOV EAX, 0E000B4H	;Y+4, X+4
		JMP SETSPRITEBUTTON
	COMPASS4:
	CMP R8, 04H
	JNZ COMPASS5
		MOV EAX, 0E200B0H	;Y+6
		JMP SETSPRITEBUTTON
	COMPASS5:
	CMP R8, 06H
	JNZ COMPASS6
		MOV EAX, 0E000ACH	;Y+4, X-4
		JMP SETSPRITEBUTTON
	COMPASS6:
	CMP R8, 02H
	JNZ COMPASS7
		MOV EAX, 0DC00AAH	;X-6
		JMP SETSPRITEBUTTON
	COMPASS7:
	CMP R8, 0AH
	JNZ COMPASS8
		MOV EAX, 0D800ACH	;Y-4, X-4
		JMP SETSPRITEBUTTON
	COMPASS8:
	MOV EAX, 0DC00B0H	;STANDARD X-Y
	SETSPRITEBUTTON:
		MOV DWORD PTR [SPRITES + 0CH], EAX	;STORE BALL LOCATION
	MOV AL, BYTE PTR [COMBFIRE]
	ADD AL, 03CH
	MOV BYTE PTR [SPRITES + 01AH], AL
	
	ENDMOVESHIP:
ENDM


SPAWNENEMY MACRO X, Y, Z	;2D X AND Y [0-255], Z ALTITUDE [0-3]
	;ENEMY TYPE LOADED INTO R8

;ENEMYOBJ STRUCT
;	MODE DW ?	;0 IF INACTIVE
;	SPRITE DW ?
;	X DW ?
;	Y DW ?
;	HITBOXX DB ?	;X & Y ARE OFFSET FROM TOP LEFT CORNER
;	HITBOXY DB ?
;	HITBOXW DB ?
;	HITBOXH DB ?
;	ALT		DB ?	;ALTITUDE 
;ENEMYOBJ ENDS
;ENEMYOBJSIZE = 0DH
;ENEMY ENEMYOBJ 040H DUP(<>)	;64 ENEMIES
	
	LOCAL ENDSPAWNENEMY
	LOCAL SLOTSEARCHLOOP
	LOCAL DETECTINGENEMYTYPE
	LOCAL SPAWNENTRYWALL
	LOCAL NEXTENEMYCLEAN1
	LOCAL NEXTENEMYCLEAN2
	LOCAL WALLLOOP
	LOCAL WALLLOOP2
	LOCAL WALLLOOP3
	LOCAL SPAWNDISH
	LOCAL SPAWNFRONTTURRENT
	LOCAL SPAWNSIDETURRENT
	LOCAL SPAWNTANKER
	LOCAL SPAWNMISSLEUP
	LOCAL SPAWNEBOLT
	LOCAL SPAWNSPRAY
	LOCAL SPAWNWALL
	LOCAL SPAWNWALL2
	LOCAL SPAWNGROUNDPLANE
	LOCAL SPAWNSPACEPLANE
	LOCAL DISTANCELOOP
	LOCAL SPAWNENTRYWALLMEDIUM
	LOCAL SPAWNENTRYWALLLOW
	LOCAL SPAWNMISSLE
	LOCAL SPAWNBOSS
	
	;FIND OPEN ENEMY SLOT
	LEA RDX, QWORD PTR [ENEMY]
	MOV RCX, NUMBEROFENEMY	;MAX NUMBER OF OPEN SLOTS
	XOR R15, R15
	SLOTSEARCHLOOP:
		MOV AL, BYTE PTR [RDX]
		CMP AL, 00H
		JZ DETECTINGENEMYTYPE	;THIS SLOT IS OPEN
		INC R15
		ADD RDX, ENEMYOBJSIZE
		LOOP SLOTSEARCHLOOP
		;IF EMPTY SLOT NOT FOUND, SKIP SPAWN
		JMP ENDSPAWNENEMY
	
	DETECTINGENEMYTYPE:
		CMP R8, 01H
		JZ SPAWNENTRYWALL
		CMP R8, 02H
		JZ SPAWNENTRYWALLMEDIUM
		CMP R8, 03H
		JZ SPAWNENTRYWALLLOW
		CMP R8, 04H
		JZ SPAWNBOSS		
		CMP R8, 01CH
		JZ SPAWNMISSLEUP
		CMP R8, 023H
		JZ SPAWNFRONTTURRENT
		CMP R8, 024H
		JZ SPAWNSIDETURRENT
		CMP R8, 025H
		JZ SPAWNTANKER
		CMP R8, 026H
		JZ SPAWNDISH
		CMP R8, 027H
		JZ SPAWNEBOLT
		CMP R8, 029H
		JZ SPAWNSPRAY
		CMP R8, 021H
		JZ SPAWNWALL
		CMP R8, 022H
		JZ SPAWNWALL2
		CMP R8, 019H
		JZ SPAWNGROUNDPLANE
		CMP R8, 011H
		JZ SPAWNSPACEPLANE
		CMP R8, 01BH
		JZ SPAWNMISSLE
		;IF ENEMY TYPE NOT FOUND, SKIP SPAWN
		JMP ENDSPAWNENEMY
	
	SPAWNENTRYWALL:
		;SINCE THIS IS THE FIRST EVENT, I KNOW THAT ALL THE ENEMIES ARE CLEAR
		;SO I'M GOING TO SPAWN MULTIPLE AT ONCE, DON'T DO THAT OTHERWISE
		MOV RAX, 101
		MOV RBX, 50
		MOV RCX, 0DH
		WALLLOOP:
			MOV BYTE PTR [RDX], 0DH		;MODE 1 + LONG SPRITE + INVISIBLE
			MOV BYTE PTR [RDX + 01H], 00H
			MOV BYTE PTR [RDX + 02H], 011H	;SPRITE
			MOV BYTE PTR [RDX + 04H], AL
			MOV BYTE PTR [RDX + 06H], BL
			MOV BYTE PTR [RDX + 0CH], 02H	;ALT
			MOV BYTE PTR [RDX + 0DH], 00H	;TIMER
				;HIT BOX:
				PUSH RAX
				MOV EAX, 03A140000H			;HWYX
				MOV DWORD PTR [RDX + 08H], EAX	;HITBOX
				POP RAX
			ADD AL, 08H
			ADD BL, 04H
			ADD RDX, ENEMYOBJSIZE
			LOOP WALLLOOP
		;FINAL WALL ON RIGHT SIDE:
			MOV BYTE PTR [RDX], 0DH		;MODE 1 + LONG SPRITE + INVISIBLE
			MOV BYTE PTR [RDX + 01H], 00H
			MOV BYTE PTR [RDX + 02H], 011H	;SPRITE
			MOV BYTE PTR [RDX + 04H], 221
			MOV BYTE PTR [RDX + 06H], 97
			MOV BYTE PTR [RDX + 0CH], 03H	;ALT
				;HIT BOX:
				MOV EAX, 042140000H			;HWYX
				MOV DWORD PTR [RDX + 08H], EAX	;HITBOX
		JMP ENDSPAWNENEMY
		
	SPAWNENTRYWALLMEDIUM:
		;SINCE THIS IS THE FIRST EVENT, I KNOW THAT ALL THE ENEMIES ARE CLEAR
		;SO I'M GOING TO SPAWN MULTIPLE AT ONCE, DON'T DO THAT OTHERWISE		
		MOV RAX, 101
		MOV RBX, 66
		MOV RCX, 0DH
		WALLLOOP2:
			MOV BYTE PTR [RDX], 0DH		;MODE 1 + LONG SPRITE + INVISIBLE
			MOV BYTE PTR [RDX + 01H], 00H
			MOV BYTE PTR [RDX + 02H], 011H	;SPRITE
			MOV BYTE PTR [RDX + 04H], AL
			MOV BYTE PTR [RDX + 06H], BL
			MOV BYTE PTR [RDX + 0CH], 01H	;ALT
			MOV BYTE PTR [RDX + 0DH], 00H	;TIMER
				;HIT BOX:
				PUSH RAX
				MOV EAX, 02A140000H			;HWYX
				MOV DWORD PTR [RDX + 08H], EAX	;HITBOX
				POP RAX
			ADD AL, 08H
			ADD BL, 04H
			NEXTENEMYCLEAN1:
				INC R15
				CMP R15, NUMBEROFENEMY
				JAE ENDSPAWNENEMY	;MAXXED OUT
				ADD RDX, ENEMYOBJSIZE
				CMP BYTE PTR [RDX], 00H
				JNZ NEXTENEMYCLEAN1
			LOOP WALLLOOP2
		;FINAL WALL ON RIGHT SIDE:
			MOV BYTE PTR [RDX], 0DH		;MODE 1 + LONG SPRITE + INVISIBLE
			MOV BYTE PTR [RDX + 01H], 00H
			MOV BYTE PTR [RDX + 02H], 011H	;SPRITE
			MOV BYTE PTR [RDX + 04H], 221
			MOV BYTE PTR [RDX + 06H], 97
			MOV BYTE PTR [RDX + 0CH], 03H	;ALT
				;HIT BOX:
				MOV EAX, 042140000H			;HWYX
				MOV DWORD PTR [RDX + 08H], EAX	;HITBOX
		JMP ENDSPAWNENEMY
		
	SPAWNENTRYWALLLOW:
		;SINCE THIS IS THE FIRST EVENT, I KNOW THAT ALL THE ENEMIES ARE CLEAR
		;SO I'M GOING TO SPAWN MULTIPLE AT ONCE, DON'T DO THAT OTHERWISE
		MOV RAX, 101
		MOV RBX, 82
		MOV RCX, 0DH
		WALLLOOP3:
			MOV BYTE PTR [RDX], 0DH		;MODE 1 + LONG SPRITE + INVISIBLE
			MOV BYTE PTR [RDX + 01H], 00H
			MOV BYTE PTR [RDX + 02H], 011H	;SPRITE
			MOV BYTE PTR [RDX + 04H], AL
			MOV BYTE PTR [RDX + 06H], BL
			MOV BYTE PTR [RDX + 0CH], 00H	;ALT
			MOV BYTE PTR [RDX + 0DH], 00H	;TIMER
				;HIT BOX:
				PUSH RAX
				MOV EAX, 01A140000H			;HWYX
				MOV DWORD PTR [RDX + 08H], EAX	;HITBOX
				POP RAX
			ADD AL, 08H
			ADD BL, 04H
			NEXTENEMYCLEAN2:
				INC R15
				CMP R15, NUMBEROFENEMY
				JAE ENDSPAWNENEMY	;MAXXED OUT
				ADD RDX, ENEMYOBJSIZE
				CMP BYTE PTR [RDX], 00H
				JNZ NEXTENEMYCLEAN2
			LOOP WALLLOOP3
		JMP ENDSPAWNENEMY
		
	SPAWNFRONTTURRENT:
		;SET UP INITIAL VALUES
		INC BYTE PTR [RDX]	;SET TO MODE 1
		MOV BYTE PTR [RDX + 01H], 00H
		MOV BYTE PTR [RDX + 02H], 023H	;SPRITE
		MOV RAX, X
		MOV BYTE PTR [RDX + 04H], AL
		MOV RAX, Y
		MOV BYTE PTR [RDX + 06H], AL
		MOV RAX, Z
		MOV BYTE PTR [RDX + 0CH], AL
		MOV BYTE PTR [RDX + 0DH], 00H	;TIMER
			;HIT BOX:
			MOV EAX, 00C13060BH			;HWYX
			MOV DWORD PTR [RDX + 08H], EAX	;HITBOX
		JMP ENDSPAWNENEMY

	SPAWNSIDETURRENT:
		;SET UP INITIAL VALUES
		INC BYTE PTR [RDX]	;SET TO MODE 1
		MOV BYTE PTR [RDX + 01H], 00H
		MOV BYTE PTR [RDX + 02H], 024H	;SPRITE
		MOV RAX, X
		MOV BYTE PTR [RDX + 04H], AL
		MOV RAX, Y
		MOV BYTE PTR [RDX + 06H], AL
		MOV RAX, Z
		MOV BYTE PTR [RDX + 0CH], AL
		MOV BYTE PTR [RDX + 0DH], 00H	;TIMER
			;HIT BOX:
			MOV EAX, 0111D0701H			;HWYX
			MOV DWORD PTR [RDX + 08H], EAX	;HITBOX
		JMP ENDSPAWNENEMY

	SPAWNTANKER:
		;SET UP INITIAL VALUES
		INC BYTE PTR [RDX]	;SET TO MODE 1
		MOV BYTE PTR [RDX + 01H], 00H
		MOV BYTE PTR [RDX + 02H], 025H	;SPRITE
		MOV RAX, X
		MOV BYTE PTR [RDX + 04H], AL
		MOV RAX, Y
		MOV BYTE PTR [RDX + 06H], AL
		MOV RAX, Z
		MOV BYTE PTR [RDX + 0CH], AL
		MOV BYTE PTR [RDX + 0DH], 00H	;TIMER
			;HIT BOX:
			MOV EAX, 01C1C0002H			;HWYX
			MOV DWORD PTR [RDX + 08H], EAX	;HITBOX
		JMP ENDSPAWNENEMY

	SPAWNDISH:
		;SET UP INITIAL VALUES
		INC BYTE PTR [RDX]	;SET TO MODE 1
		MOV BYTE PTR [RDX + 01H], 00H
		MOV BYTE PTR [RDX + 02H], 026H	;SPRITE
		MOV RAX, X
		MOV BYTE PTR [RDX + 04H], AL
		MOV RAX, Y
		MOV BYTE PTR [RDX + 06H], AL
		MOV RAX, Z
		MOV BYTE PTR [RDX + 0CH], AL
		MOV BYTE PTR [RDX + 0DH], 00H	;TIMER
			;HIT BOX:
			MOV EAX, 01A1A0202H			;HWYX
			MOV DWORD PTR [RDX + 08H], EAX	;HITBOX
		JMP ENDSPAWNENEMY
	
	SPAWNMISSLEUP:
		;SET UP INITIAL VALUES
		MOV BYTE PTR [RDX], 075H	;DELAY, INVISIBLE, NO HIT, GO UP
		MOV BYTE PTR [RDX + 01H], 00H
		MOV BYTE PTR [RDX + 02H], 01CH	;SPRITE
		MOV RAX, X
		MOV BYTE PTR [RDX + 04H], AL
		MOV RAX, Y
		MOV BYTE PTR [RDX + 06H], AL
		MOV RAX, Z
		MOV BYTE PTR [RDX + 0CH], AL
		MOV BYTE PTR [RDX + 0DH], 00H	;TIMER
			;HIT BOX:
			MOV EAX, 00A05030DH			;HWYX
			MOV DWORD PTR [RDX + 08H], EAX	;HITBOX
		JMP ENDSPAWNENEMY
		
	SPAWNEBOLT:
		;SET UP INITIAL VALUES
		MOV BYTE PTR [RDX], 081H	;SET TO MODE 1 + FLY DOWN TRACK
		MOV BYTE PTR [RDX + 01H], 00H
		MOV BYTE PTR [RDX + 02H], 027H	;SPRITE
		MOV RAX, X
		MOV BYTE PTR [RDX + 04H], AL
		MOV RAX, Y
		MOV BYTE PTR [RDX + 06H], AL
		MOV RAX, Z
		MOV BYTE PTR [RDX + 0CH], AL
		MOV BYTE PTR [RDX + 0DH], 00H	;TIMER
			;HIT BOX:
			MOV EAX, 004070F0BH			;HWYX
			MOV DWORD PTR [RDX + 08H], EAX	;HITBOX
		JMP ENDSPAWNENEMY
		
	SPAWNMISSLE:
		;SET UP INITIAL VALUES
		MOV BYTE PTR [RDX], 081H	;SET TO MODE 1 + FLY DOWN TRACK
		MOV BYTE PTR [RDX + 01H], 00H
		MOV BYTE PTR [RDX + 02H], 01BH	;SPRITE
		MOV RAX, X
		MOV BYTE PTR [RDX + 04H], AL
		MOV RAX, Y
		MOV BYTE PTR [RDX + 06H], AL
		MOV RAX, Z
		MOV BYTE PTR [RDX + 0CH], AL
		MOV BYTE PTR [RDX + 0DH], 00H	;TIMER
			;HIT BOX:
			MOV EAX, 008091201H			;HWYX
			MOV DWORD PTR [RDX + 08H], EAX	;HITBOX
		JMP ENDSPAWNENEMY

	SPAWNSPRAY:
		;SET UP INITIAL VALUES
		MOV WORD PTR [RDX], 0241H	;SET TO MODE 1 + SKIP HITBOX CHECK + SHORT TIMER
		MOV BYTE PTR [RDX + 02H], 029H	;SPRITE
		MOV RAX, X
		MOV BYTE PTR [RDX + 04H], AL
		MOV RAX, Y
		MOV BYTE PTR [RDX + 06H], AL
		MOV RAX, Z
		MOV BYTE PTR [RDX + 0CH], AL
		MOV BYTE PTR [RDX + 0DH], 00H	;TIMER
			;HIT BOX:
			MOV EAX, 000000000H			;HWYX
			MOV DWORD PTR [RDX + 08H], EAX	;HITBOX
		JMP ENDSPAWNENEMY
		
	SPAWNWALL:
		;SET UP INITIAL VALUES
		MOV WORD PTR [RDX], 01H	;SET TO MODE 1
		MOV BYTE PTR [RDX + 02H], 021H	;SPRITE
		MOV RAX, X
		MOV BYTE PTR [RDX + 04H], AL
		MOV RAX, Y
		MOV BYTE PTR [RDX + 06H], AL
		MOV RAX, Z
		MOV BYTE PTR [RDX + 0CH], AL
		MOV BYTE PTR [RDX + 0DH], 00H	;TIMER
			;HIT BOX:
			MOV EAX, 01A200300H			;HWYX
			MOV DWORD PTR [RDX + 08H], EAX	;HITBOX
		JMP ENDSPAWNENEMY		
		
	SPAWNWALL2:
		;SET UP INITIAL VALUES
		MOV WORD PTR [RDX], 01H	;SET TO MODE 1
		MOV BYTE PTR [RDX + 02H], 022H	;SPRITE
		MOV RAX, X
		MOV BYTE PTR [RDX + 04H], AL
		MOV RAX, Y
		MOV BYTE PTR [RDX + 06H], AL
		MOV RAX, Z
		MOV BYTE PTR [RDX + 0CH], AL
		MOV BYTE PTR [RDX + 0DH], 00H	;TIMER
			;HIT BOX:
			MOV EAX, 01A200300H			;HWYX
			MOV DWORD PTR [RDX + 08H], EAX	;HITBOX
		JMP ENDSPAWNENEMY

	SPAWNGROUNDPLANE:
		;SET UP INITIAL VALUES
		INC BYTE PTR [RDX]	;SET TO MODE 1
		MOV BYTE PTR [RDX + 01H], 00H
		MOV BYTE PTR [RDX + 02H], 019H	;SPRITE
		MOV RAX, X
		MOV BYTE PTR [RDX + 04H], AL
		MOV RAX, Y
		MOV BYTE PTR [RDX + 06H], AL
		MOV RAX, Z
		MOV BYTE PTR [RDX + 0CH], AL
		MOV BYTE PTR [RDX + 0DH], 00H	;TIMER
			;HIT BOX:
			MOV EAX, 00E190804H			;HWYX
			MOV DWORD PTR [RDX + 08H], EAX	;HITBOX
		JMP ENDSPAWNENEMY
		
	SPAWNSPACEPLANE:	;THESE ARE SPAWNED TO AIM AT THE PLAYER
		;SET UP INITIAL VALUES
		MOV BYTE PTR [RDX], 081H	;SET TO MODE 1 + FLY DOWN
		MOV BYTE PTR [RDX + 01H], 00H	
		MOV AL, 03H
		SUB AL, BYTE PTR [SHIPALT]	;REVERSE ORDER
		ADD AL, 011H	;BASE SPRITE
		MOV BYTE PTR [RDX + 02H], AL	;SPRITE
		
		LEA RBX, [SPRITES]	;FIRST SPRITE IS SHIP SPRITE
		MOV AL, BYTE PTR [RBX + 04H]	;X
		MOV BL, BYTE PTR [RBX + 06H] 	;Y
		
		DISTANCELOOP:
			INC AL
			INC AL
			DEC BL
			CMP AL, 0EDH
			JB DISTANCELOOP
		
		MOV BYTE PTR [RDX + 04H], AL
		MOV BYTE PTR [RDX + 06H], BL
		MOV AL, BYTE PTR [SHIPALT]
		MOV BYTE PTR [RDX + 0CH], AL
		MOV BYTE PTR [RDX + 0DH], 00H	;TIMER
			;HIT BOX:
			MOV EAX, 00E190804H			;HWYX
			MOV DWORD PTR [RDX + 08H], EAX	;HITBOX
		JMP ENDSPAWNENEMY	
		
	SPAWNBOSS:
		;FOUR HIT BOXES
		LEA RDX, QWORD PTR [ENEMY]
		MOV WORD PTR [RDX], 01803H	;SET TO MODE 1 + 6 HIT POINTS
		MOV BYTE PTR [RDX + 02H], 034H	;SPRITE
		MOV RAX, X
		MOV BYTE PTR [RDX + 04H], AL
		MOV RAX, Y
		MOV BYTE PTR [RDX + 06H], AL
		MOV RAX, 0	;0 ALTITUDE
		MOV BYTE PTR [RDX + 0CH], AL
		MOV BYTE PTR [RDX + 0DH], 00H	;TIMER
			;HIT BOX:
			MOV EAX, 032320707H			;HWYX
			MOV DWORD PTR [RDX + 08H], EAX	;HITBOX
		
		ADD RDX, ENEMYOBJSIZE
		MOV BYTE PTR [RDX], 043H	;SET TO MODE + NO HITBOX CHECK
		MOV BYTE PTR [RDX + 01H], 00H
		MOV BYTE PTR [RDX + 02H], 035H	;SPRITE
		MOV RAX, X
		ADD RAX, 020H
		MOV BYTE PTR [RDX + 04H], AL
		MOV RAX, Y
		MOV BYTE PTR [RDX + 06H], AL
		MOV RAX, Z
		MOV BYTE PTR [RDX + 0CH], AL
		MOV BYTE PTR [RDX + 0DH], 00H	;TIMER
			;HIT BOX:
			MOV EAX, 000000000H			;HWYX
			MOV DWORD PTR [RDX + 08H], EAX	;HITBOX
		
		ADD RDX, ENEMYOBJSIZE
		MOV BYTE PTR [RDX], 043H	;SET TO MODE + NO HITBOX CHECK
		MOV BYTE PTR [RDX + 01H], 00H
		MOV BYTE PTR [RDX + 02H], 036H	;SPRITE
		MOV RAX, X
		MOV BYTE PTR [RDX + 04H], AL
		MOV RAX, Y
		ADD RAX, 020H
		MOV BYTE PTR [RDX + 06H], AL
		MOV RAX, Z
		DEC RAX
		MOV BYTE PTR [RDX + 0CH], AL
		MOV BYTE PTR [RDX + 0DH], 00H	;TIMER
			;HIT BOX:
			MOV EAX, 000000000H			;HWYX
			MOV DWORD PTR [RDX + 08H], EAX	;HITBOX
			
		ADD RDX, ENEMYOBJSIZE
		MOV BYTE PTR [RDX], 043H	;SET TO MODE + NO HITBOX CHECK
		MOV BYTE PTR [RDX + 01H], 00H
		MOV BYTE PTR [RDX + 02H], 037H	;SPRITE
		MOV RAX, X
		ADD RAX, 020H
		MOV BYTE PTR [RDX + 04H], AL
		MOV RAX, Y
		ADD RAX, 020H
		MOV BYTE PTR [RDX + 06H], AL
		MOV RAX, Z
		DEC RAX
		MOV BYTE PTR [RDX + 0CH], AL
		MOV BYTE PTR [RDX + 0DH], 00H	;TIMER
			;HIT BOX:
			MOV EAX, 000000000H			;HWYX
			MOV DWORD PTR [RDX + 08H], EAX	;HITBOX	
			
		JMP ENDSPAWNENEMY	
	
	ENDSPAWNENEMY:
ENDM

COLUMNTICKEVENTS MACRO
	;EVENTS RELATED TO SCROLLING MAP TRIGGERED AT CERTAIN COLUMNS
		;INCLUDING: SHIP SHADOW ON/OFF, SPAWN ENEMIES, &C.
		;EVENTS BROKEN UP BY STAGE
	LOCAL STAGE1EVENTS
	LOCAL STAGE2EVENTS
	LOCAL STAGE3EVENTS
	LOCAL ENDCOLUMNTICKEVENTS

	MOV RAX, COLUMNTICK
	MOV RBX, STAGE
	CMP RBX, 02H
	JZ STAGE3EVENTS
	CMP RBX, 01H
	JZ STAGE2EVENTS
	JMP STAGE1EVENTS


	;COULD BE REDESIGNED INTO A JUMP TABLE FOR QUICKER ACCESS
	;FROM SIDE TO NEW TILES IS 128px
	
	STAGE3EVENTS:	;2ND FLYOVER AREA
		S3E1:
			CMP RAX, 0A8H
			JNZ S3E2
			MOV R8, 01H	;SPAWN ENTRY WALLS
			SPAWNENEMY 50, 0, 0
			JMP ENDCOLUMNTICKEVENTS
		S3E2:
			CMP RAX, 0ACH
			JNZ S3E3
			MOV HIDESHADOW, 01H	;HIDE SHADOW
			JMP ENDCOLUMNTICKEVENTS
		S3E3:
			CMP RAX, 0B2H
			JNZ S3E4
			MOV HIDESHADOW, 00H	;UNHIDE SHADOW
			MOV R8, 026H	;SPAWN DISH
			SPAWNENEMY 229, 104, 0
			JMP ENDCOLUMNTICKEVENTS
		S3E4:
			CMP RAX, 0AAH
			JNZ S3E5
			MOV R8, 025H	;TANKER
			SPAWNENEMY 221, 56, 0
			JMP ENDCOLUMNTICKEVENTS
		S3E5:
			CMP RAX, 0A4H
			JNZ S3E6
			MOV R8, 022H	;WALL
			SPAWNENEMY 229, 32, 3
			JMP ENDCOLUMNTICKEVENTS
		S3E6:
			CMP RAX, 0A5H
			JNZ S3E7
			MOV R8, 022H	;WALL
			SPAWNENEMY 237, 51, 3
			JMP ENDCOLUMNTICKEVENTS
		S3E7:
			CMP RAX, 0AFH
			JNZ S3E8
			MOV R8, 024H	;SIDE TURRENT
			SPAWNENEMY 226, 110, 0
			JMP ENDCOLUMNTICKEVENTS
		S3E8:
			CMP RAX, 0ADH
			JNZ S3E9
			MOV R8, 023H	;FRONT TURRENT
			SPAWNENEMY 222, 25, 0
			JMP ENDCOLUMNTICKEVENTS
		S3E9:
			CMP RAX, 0B0H
			JNZ S3E10
			MOV R8, 025H	;TANKER
			SPAWNENEMY 229, 72, 0
			JMP ENDCOLUMNTICKEVENTS
		S3E10:
			CMP RAX, 0B1H
			JNZ S3E12
			MOV R8, 021H	;WALL
			SPAWNENEMY 205, 4, 1
			JMP ENDCOLUMNTICKEVENTS
		S3E12:
			CMP RAX, 0B5H
			JNZ S3E13_25
			MOV R8, 022H	;WALL
			SPAWNENEMY 237, 83, 1
			MOV R8, 01CH	;UP MISSLE
			SPAWNENEMY 221, 52, 0
			JMP ENDCOLUMNTICKEVENTS
		S3E13_25:
			CMP RAX, 0B8H
			JNZ S3E13_5
			MOV R8, 03H	;LOW WALLS
			SPAWNENEMY 0, 0, 0
			JMP ENDCOLUMNTICKEVENTS
		S3E13_5:
			CMP RAX, 0BCH
			JNZ S3E13
			MOV HIDESHADOW, 01H	;HIDE SHADOW
			JMP ENDCOLUMNTICKEVENTS
		S3E13:
			CMP RAX, 0BDH
			JNZ S3E14
			MOV R8, 01CH	;UP MISSLE
			SPAWNENEMY 229, 95, 0
			JMP ENDCOLUMNTICKEVENTS
		S3E14:
			CMP RAX, 0BBH
			JNZ S3E15
			MOV R8, 025H	;TANKER
			SPAWNENEMY 238, 51, 0
			JMP ENDCOLUMNTICKEVENTS
		S3E15:
			CMP RAX, 0BEH
			JNZ S3E16
			MOV R8, 025H	;TANKER
			SPAWNENEMY 225, 57, 0
			MOV R8, 023H	;FRONT TURRENT
			SPAWNENEMY 228, 26, 0
			JMP ENDCOLUMNTICKEVENTS
		S3E16:
			CMP RAX, 0C0H
			JNZ S3E17
			MOV R8, 025H	;TANKER
			SPAWNENEMY 229, 55, 0
			JMP ENDCOLUMNTICKEVENTS
		S3E17:
			CMP RAX, 0C2H
			JNZ S3E18
			MOV R8, 023H	;FRONT TURRENT
			SPAWNENEMY 226, 91, 0
			MOV HIDESHADOW, 00H	;UNHIDE SHADOW
			JMP ENDCOLUMNTICKEVENTS
		S3E18:
			CMP RAX, 0C5H
			JNZ S3E19
			MOV R8, 022H	;WALL
			SPAWNENEMY 229, 48, 2
			MOV R8, 01CH	;UP MISSLE
			SPAWNENEMY 213, 16, 0
			JMP ENDCOLUMNTICKEVENTS
		S3E19:
			CMP RAX, 0C7H
			JNZ S3E20
			MOV R8, 022H	;WALL
			SPAWNENEMY 223, 76, 2
			JMP ENDCOLUMNTICKEVENTS
		S3E20:
			CMP RAX, 0C9H
			JNZ S3E21
			MOV R8, 02H	;MEDIUM WALLS
			SPAWNENEMY 0, 0, 0
			MOV R8, 025H	;TANKER
			SPAWNENEMY 233, 29, 0
			JMP ENDCOLUMNTICKEVENTS
		S3E21:
			CMP RAX, 0CDH
			JNZ S3E22
			MOV HIDESHADOW, 01H	;HIDE SHADOW
			JMP ENDCOLUMNTICKEVENTS
		S3E22:
			CMP RAX, 0D3H
			JNZ S3E23
			MOV HIDESHADOW, 00H	;UNHIDE SHADOW
			JMP ENDCOLUMNTICKEVENTS
		S3E23:
			CMP RAX, 0CBH
			JNZ S3E24
			MOV R8, 025H	;TANKER
			SPAWNENEMY 237, 59, 0
			MOV R8, 01CH	;UP MISSLE
			SPAWNENEMY 229, 80, 0
			JMP ENDCOLUMNTICKEVENTS
		S3E24:
			CMP RAX, 0CEH
			JNZ S3E25
			MOV R8, 025H	;TANKER
			SPAWNENEMY 229, 87, 0
			JMP ENDCOLUMNTICKEVENTS
		S3E25:
			CMP RAX, 0CCH
			JNZ S3E26
			MOV R8, 01CH	;UP MISSLE
			SPAWNENEMY 238, 28, 0
			JMP ENDCOLUMNTICKEVENTS
		S3E26:
			CMP RAX, 0D1H
			JNZ S3E27
			MOV R8, 024H	;SIDE TURRENT
			SPAWNENEMY 226, 110, 0
			JMP ENDCOLUMNTICKEVENTS
		S3E27:
			CMP RAX, 0CFH
			JNZ S3E28
			MOV R8, 022H	;WALL
			SPAWNENEMY 229, 8, 0
			JMP ENDCOLUMNTICKEVENTS
		S3E28:
			CMP RAX, 0D0H
			JNZ S3E29
			MOV R8, 021H	;WALL
			SPAWNENEMY 237, 28, 0
			JMP ENDCOLUMNTICKEVENTS
		S3E29:
			CMP RAX, 0D5H
			JNZ S3E30
			MOV R8, 022H	;WALL
			SPAWNENEMY 229, 104, 0
			MOV R8, 023H	;FRONT TURRENT
			SPAWNENEMY 232, 24, 0
			JMP ENDCOLUMNTICKEVENTS
		S3E30:
			CMP RAX, 0D2H
			JNZ S3E31
			MOV R8, 01CH	;UP MISSLE
			SPAWNENEMY 237, 12, 0
			JMP ENDCOLUMNTICKEVENTS
		S3E31:
			CMP RAX, 0D8H
			JNZ S3E32
			MOV R8, 025H	;TANKER
			SPAWNENEMY 233, 17, 0
			JMP ENDCOLUMNTICKEVENTS
		S3E32:
			CMP RAX, 0DBH
			JNZ S3E33_5
			MOV R8, 023H	;FRONT TURRENT
			SPAWNENEMY 236, 100, 0
			MOV HIDESHADOW, 01H	;HIDE SHADOW
			JMP ENDCOLUMNTICKEVENTS
		S3E33_5:
			CMP RAX, 0DCH
			JNZ S3E33
			JMP ENDCOLUMNTICKEVENTS
		S3E33:
			CMP RAX, 0DDH
			JNZ S3E34
			MOV R8, 025H	;TANKER
			SPAWNENEMY 229, 47, 0
			JMP ENDCOLUMNTICKEVENTS
		S3E34:
			CMP RAX, 0DFH
			JNZ S3E35
			MOV R8, 026H	;SPAWN DISH
			SPAWNENEMY 238, 108, 0
			MOV HIDESHADOW, 00H	;UNHIDE SHADOW
			JMP ENDCOLUMNTICKEVENTS
		S3E35:
			CMP RAX, 0E0H
			JNZ S3E36
			MOV R8, 023H	;FRONT TURRENT
			SPAWNENEMY 234, 75, 0
			JMP ENDCOLUMNTICKEVENTS
		S3E36:
			CMP RAX, 0E1H
			JNZ S3E37
			MOV R8, 021H	;WALL
			SPAWNENEMY 205, 4, 1
			JMP ENDCOLUMNTICKEVENTS
		S3E37:
			CMP RAX, 0E4H
			JNZ S3E38
			MOV R8, 022H	;WALL
			SPAWNENEMY 229, 64, 1
			JMP ENDCOLUMNTICKEVENTS
		S3E38:
			CMP RAX, 0E5H
			JNZ S3E39
			MOV R8, 022H	;WALL
			SPAWNENEMY 238, 84, 1
			MOV R8, 01CH	;UP MISSLE
			SPAWNENEMY 222, 51, 0
			MOV R8, 025H	;TANKER
			SPAWNENEMY 237, 15, 0
			JMP ENDCOLUMNTICKEVENTS
		S3E39:
			CMP RAX, 0E8H
			JNZ S3E48
			MOV R8, 03H	;LOW WALLS
			SPAWNENEMY 0, 0, 0
			JMP ENDCOLUMNTICKEVENTS
		S3E48:
			CMP RAX, 0EBH
			JNZ S3E49
			MOV HIDESHADOW, 01H	;HIDE SHADOW
			JMP ENDCOLUMNTICKEVENTS
		S3E49:
			CMP RAX, 0F8H
			JNZ S3E50
			MOV PAUSESCROLL, 01H	;PAUSE SCROLL
			MOV R8, 04H	;BOSS
			SPAWNENEMY 172, 66, 2
			JMP ENDCOLUMNTICKEVENTS
		S3E50:
			CMP RAX, 0F2H
			JNZ S3E51
			MOV HIDESHADOW, 00H	;UNHIDE SHADOW
			JMP ENDCOLUMNTICKEVENTS
		S3E51:
		JMP ENDCOLUMNTICKEVENTS
	
	STAGE2EVENTS:	;SPACE EVENTS
		S2E1:
			CMP RAX, 072H
			JNZ S2E2
			MOV HIDESHADOW, 01H	;TURN SHADOW OFF
			JMP ENDCOLUMNTICKEVENTS
		S2E2:
			CMP RAX, 070H
			JNZ S2E3
			MOV R8, 011H	;TARGETED SPACE PLANE
			SPAWNENEMY 0, 0, 0
			JMP ENDCOLUMNTICKEVENTS
			
		S2E3:
			CMP RAX, 070H
			JNZ S2E4
			MOV R8, 011H	;TARGETED SPACE PLANE
			SPAWNENEMY 0, 0, 0
			JMP ENDCOLUMNTICKEVENTS
		S2E4:
			CMP RAX, 074H
			JNZ S2E5
			MOV R8, 011H	;TARGETED SPACE PLANE
			SPAWNENEMY 0, 0, 0
			JMP ENDCOLUMNTICKEVENTS
		S2E5:
			CMP RAX, 078H
			JNZ S2E6
			MOV R8, 011H	;TARGETED SPACE PLANE
			SPAWNENEMY 0, 0, 0
			JMP ENDCOLUMNTICKEVENTS
		S2E6:
			CMP RAX, 07CH
			JNZ S2E7
			MOV R8, 011H	;TARGETED SPACE PLANE
			SPAWNENEMY 0, 0, 0
			JMP ENDCOLUMNTICKEVENTS
		S2E7:
			CMP RAX, 080H
			JNZ S2E8
			MOV R8, 011H	;TARGETED SPACE PLANE
			SPAWNENEMY 0, 0, 0
			JMP ENDCOLUMNTICKEVENTS
		S2E8:
			CMP RAX, 084H
			JNZ S2E9
			MOV R8, 011H	;TARGETED SPACE PLANE
			SPAWNENEMY 0, 0, 0
			JMP ENDCOLUMNTICKEVENTS
		S2E9:
			CMP RAX, 088H
			JNZ S2E10
			MOV R8, 011H	;TARGETED SPACE PLANE
			SPAWNENEMY 0, 0, 0
			JMP ENDCOLUMNTICKEVENTS
		S2E10:
			CMP RAX, 08CH
			JNZ S2E11
			MOV R8, 011H	;TARGETED SPACE PLANE
			SPAWNENEMY 0, 0, 0
			JMP ENDCOLUMNTICKEVENTS
		S2E11:
			CMP RAX, 090H
			JNZ S2E12
			MOV R8, 011H	;TARGETED SPACE PLANE
			SPAWNENEMY 0, 0, 0
			JMP ENDCOLUMNTICKEVENTS
		S2E12:
			CMP RAX, 094H
			JNZ S2E13
			MOV R8, 011H	;TARGETED SPACE PLANE
			SPAWNENEMY 0, 0, 0
			JMP ENDCOLUMNTICKEVENTS
		S2E13:
			CMP RAX, 09CH
			JNZ ENDCOLUMNTICKEVENTS
			MOV HIDESHADOW, 00H	;TURN SHADOW BACK ON
			INC STAGE	;MOVE TO NEXT STAGE
			JMP ENDCOLUMNTICKEVENTS
		JMP ENDCOLUMNTICKEVENTS
	
	STAGE1EVENTS:	;1ST FLYOVER AREA
		S1E0:	;TURN SHADOW OFF FOR WALL FLYOVER + FRONT TURRENT
			CMP RAX, 09H
			JNZ S1E1				
			MOV HIDESHADOW, 01H
			MOV R8, 023H	;SPAWN FRONT FACING TURRENT
			SPAWNENEMY 239, 40, 0
			JMP ENDCOLUMNTICKEVENTS
		S1E1:	;TURN ON SHADOW AFTER WALL FLYOVER
			CMP RAX, 0FH
			JNZ S1E2
			MOV HIDESHADOW, 00H
			JMP ENDCOLUMNTICKEVENTS
		S1E2:	
			CMP RAX, 0BH
			JNZ S1E3
			MOV R8, 026H	;SPAWN DISH
			SPAWNENEMY 218, 112, 0
			JMP ENDCOLUMNTICKEVENTS
		S1E3:	;SPAWNING WALL OF ENEMIES IN FRONT
			CMP RAX, 05H
			JNZ S1E4
			MOV R8, 01H	;SPAWN ENTRY WALLS
			SPAWNENEMY 50, 0, 0
			JMP ENDCOLUMNTICKEVENTS
		S1E4:	;SPAWNING SIDE TURRENT
			CMP RAX, 0EH
			JNZ S1E5
			MOV R8, 024H	;SIDE TURRENT
			SPAWNENEMY 216, 116, 0
			MOV R8, 01CH	;UP MISSLE
			SPAWNENEMY 230, 25, 0
			JMP ENDCOLUMNTICKEVENTS
		S1E5:	;SPAWN TANKER
			CMP RAX, 011H
			JNZ S1E6
			MOV R8, 025H	;TANKER
			SPAWNENEMY 217, 30, 0
			MOV R8, 01CH	;UP MISSLE
			SPAWNENEMY 197, 86, 0
			JMP ENDCOLUMNTICKEVENTS
		S1E6:	;SPAWN UP MISSLE
			CMP RAX, 07H
			JNZ S1E7
			MOV R8, 01CH	;UP MISSLE
			SPAWNENEMY 229, 60, 0
			JMP ENDCOLUMNTICKEVENTS
		S1E7:	;SPAWN UP MISSLE
			CMP RAX, 0DH
			JNZ S1E8
			MOV R8, 01CH	;UP MISSLE
			SPAWNENEMY 221, 30, 0
			JMP ENDCOLUMNTICKEVENTS
		S1E8:
			CMP RAX, 012H
			JNZ S1E9
			MOV R8, 025H	;TANKER
			SPAWNENEMY 217, 70, 0
			JMP ENDCOLUMNTICKEVENTS
		S1E9:
			CMP RAX, 015H
			JNZ S1E10
			MOV R8, 01CH	;UP MISSLE
			SPAWNENEMY 200, 128, 0
			JMP ENDCOLUMNTICKEVENTS
		S1E10:
			CMP RAX, 017H
			JNZ S1E11
			MOV R8, 025H	;TANKER
			SPAWNENEMY 225, 114, 0
			MOV R8, 022H	;WALL
			SPAWNENEMY 229, 61, 0
			JMP ENDCOLUMNTICKEVENTS		
		S1E11:
			CMP RAX, 018H
			JNZ S1E12
			MOV R8, 022H	;WALL
			SPAWNENEMY 237, 81, 0
			JMP ENDCOLUMNTICKEVENTS
		S1E12:
			CMP RAX, 01AH
			JNZ S1E13
			MOV R8, 024H	;SIDE TURRENT
			SPAWNENEMY 226, 66, 0
			MOV R8, 01CH	;UP MISSLE
			SPAWNENEMY 198, 28, 0
			MOV R8, 022H	;LAST WALL
			SPAWNENEMY 229, 108, 0
		S1E13:
			CMP RAX, 01DH
			JNZ S1E14
			MOV R8, 01CH	;UP MISSLE
			SPAWNENEMY 214, 94, 0
			JMP ENDCOLUMNTICKEVENTS
		S1E14:
			CMP RAX, 01EH
			JNZ S1E15
			MOV R8, 025H	;TANKER
			SPAWNENEMY 220, 26, 0
			JMP ENDCOLUMNTICKEVENTS
		S1E15:
			CMP RAX, 01FH
			JNZ S1E16
			MOV R8, 01CH	;UP MISSLE
			SPAWNENEMY 230, 74, 0
			JMP ENDCOLUMNTICKEVENTS
		S1E16:
			CMP RAX, 020H
			JNZ S1E17
			MOV R8, 025H	;TANKER
			SPAWNENEMY 232, 110, 0
			JMP ENDCOLUMNTICKEVENTS
		S1E17:
			CMP RAX, 021H
			JNZ S1E18
			MOV R8, 01CH	;UP MISSLE
			SPAWNENEMY 230, 52, 0
			MOV R8, 01CH	;UP MISSLE
			SPAWNENEMY 238, 80, 0
			JMP ENDCOLUMNTICKEVENTS
		S1E18:
			CMP RAX, 022H
			JNZ S1E19
			MOV R8, 024H	;SIDE TURRENT
			SPAWNENEMY 236, 112, 0
			JMP ENDCOLUMNTICKEVENTS
		S1E19:
			CMP RAX, 023H
			JNZ S1E20
			MOV R8, 025H	;TANKER
			SPAWNENEMY 229, 48, 0
			JMP ENDCOLUMNTICKEVENTS
		S1E20:
			CMP RAX, 026H
			JNZ S1E21
			MOV R8, 023H	;SPAWN FRONT FACING TURRENT
			SPAWNENEMY 231, 86, 0
			JMP ENDCOLUMNTICKEVENTS
		S1E21:
			CMP RAX, 027H
			JNZ S1E22
			MOV R8, 01CH	;UP MISSLE
			SPAWNENEMY 230, 22, 0
			JMP ENDCOLUMNTICKEVENTS
		S1E22:
			CMP RAX, 028H
			JNZ S1E23
			MOV R8, 023H	;SPAWN FRONT FACING TURRENT
			SPAWNENEMY 235, 115, 0
			JMP ENDCOLUMNTICKEVENTS
		S1E23:
			CMP RAX, 029H
			JNZ S1E24
			MOV R8, 025H	;TANKER
			SPAWNENEMY 229, 20, 0
			JMP ENDCOLUMNTICKEVENTS
		S1E24:
			CMP RAX, 02BH
			JNZ S1E25
			MOV R8, 01CH	;UP MISSLE
			SPAWNENEMY 230, 115, 0
			JMP ENDCOLUMNTICKEVENTS
		S1E25:
			CMP RAX, 02DH
			JNZ S1E26
			MOV R8, 01CH	;UP MISSLE
			SPAWNENEMY 222, 79, 0
			MOV R8, 022H	;WALL
			SPAWNENEMY 229, 11, 0
			JMP ENDCOLUMNTICKEVENTS
		S1E26:
			CMP RAX, 02EH
			JNZ S1E27
			MOV R8, 022H	;WALL
			SPAWNENEMY 237, 31, 0
			JMP ENDCOLUMNTICKEVENTS
		S1E27:
			CMP RAX, 030H
			JNZ S1E28
			MOV R8, 021H	;LAST WALL
			SPAWNENEMY 229, 60, 0
			JMP ENDCOLUMNTICKEVENTS
		S1E28:
			CMP RAX, 032H
			JNZ S1E29
			MOV R8, 023H	;SPAWN FRONT FACING TURRENT
			SPAWNENEMY 227, 107, 0
			MOV R8, 01CH	;UP MISSLE
			SPAWNENEMY 221, 80, 0
			MOV R8, 01CH	;UP MISSLE
			SPAWNENEMY 221, 40, 0
			JMP ENDCOLUMNTICKEVENTS
		S1E29:
			CMP RAX, 035H
			JNZ S1E30
			MOV R8, 01CH	;UP MISSLE
			SPAWNENEMY 230, 123, 0
			JMP ENDCOLUMNTICKEVENTS
		S1E30:
			CMP RAX, 037H
			JNZ S1E31
			MOV R8, 023H	;SPAWN FRONT FACING TURRENT
			SPAWNENEMY 218, 25, 0
			JMP ENDCOLUMNTICKEVENTS
		S1E31:
			CMP RAX, 03AH
			JNZ S1E32
			MOV R8, 01CH	;UP MISSLE
			SPAWNENEMY 237, 97, 0
			JMP ENDCOLUMNTICKEVENTS
		S1E32:
			CMP RAX, 03CH
			JNZ S1E33
			MOV R8, 019H	;GROUND PLANE
			SPAWNENEMY 233, 105, 0
			MOV R8, 019H	;GROUND PLANE
			SPAWNENEMY 224, 55, 0
			MOV R8, 01CH	;UP MISSLE
			SPAWNENEMY 238, 69, 0
			JMP ENDCOLUMNTICKEVENTS
		S1E33:
			CMP RAX, 03DH
			JNZ S1E34
			MOV R8, 01CH	;UP MISSLE
			SPAWNENEMY 237, 70, 0
			JMP ENDCOLUMNTICKEVENTS
		S1E34:
			CMP RAX, 040H
			JNZ S1E35
			MOV R8, 025H	;TANKER
			SPAWNENEMY 229, 100, 0
			JMP ENDCOLUMNTICKEVENTS
		S1E35:
			CMP RAX, 042H
			JNZ S1E36
			MOV R8, 025H	;TANKER
			SPAWNENEMY 237, 68, 0
			JMP ENDCOLUMNTICKEVENTS
		S1E36:
			CMP RAX, 045H
			JNZ S1E37
			MOV R8, 023H	;SPAWN FRONT FACING TURRENT
			SPAWNENEMY 217, 130, 0
			JMP ENDCOLUMNTICKEVENTS
		S1E37:
			CMP RAX, 046H
			JNZ S1E38
			MOV R8, 026H	;SPAWN DISH
			SPAWNENEMY 229, 45, 0
			MOV R8, 023H	;SPAWN FRONT FACING TURRENT
			SPAWNENEMY 225, 21, 0
			JMP ENDCOLUMNTICKEVENTS
		S1E38:
			CMP RAX, 048H
			JNZ S1E39
			MOV R8, 01CH	;UP MISSLE
			SPAWNENEMY 238, 20, 0
			JMP ENDCOLUMNTICKEVENTS
		S1E39:
			CMP RAX, 049H
			JNZ S1E40
			MOV R8, 01CH	;UP MISSLE
			SPAWNENEMY 230, 73, 0
			JMP ENDCOLUMNTICKEVENTS
		S1E40:
			CMP RAX, 04AH
			JNZ S1E41
			MOV R8, 01CH	;UP MISSLE
			SPAWNENEMY 238, 70, 0
			MOV R8, 01CH	;UP MISSLE
			SPAWNENEMY 238, 100, 0
			JMP ENDCOLUMNTICKEVENTS
		S1E41:
			CMP RAX, 04CH
			JNZ S1E42
			MOV R8, 025H	;TANKER
			SPAWNENEMY 238, 68, 0
			MOV R8, 023H	;SPAWN FRONT FACING TURRENT
			SPAWNENEMY 233, 20, 0
			JMP ENDCOLUMNTICKEVENTS
		S1E42:
			CMP RAX, 04EH
			JNZ S1E43
			MOV R8, 01CH	;UP MISSLE
			SPAWNENEMY 237, 43, 0
			JMP ENDCOLUMNTICKEVENTS
		S1E43:
			CMP RAX, 050H
			JNZ S1E44
			MOV R8, 019H	;GROUND PLANE
			SPAWNENEMY 231, 51, 0
			JMP ENDCOLUMNTICKEVENTS
		S1E44:
			CMP RAX, 051H
			JNZ S1E45
			MOV R8, 01CH	;UP MISSLE
			SPAWNENEMY 237, 70, 0
			JMP ENDCOLUMNTICKEVENTS
		S1E45:
			CMP RAX, 052H
			JNZ S1E46
			MOV R8, 01CH	;UP MISSLE
			SPAWNENEMY 228, 102, 0
			JMP ENDCOLUMNTICKEVENTS
		S1E46:
			CMP RAX, 053H
			JNZ S1E47
			MOV R8, 019H	;GROUND PLANE
			SPAWNENEMY 235, 25, 0
			JMP ENDCOLUMNTICKEVENTS
		S1E47:
			CMP RAX, 055H
			JNZ S1E48
			MOV R8, 023H	;SPAWN FRONT FACING TURRENT
			SPAWNENEMY 233, 112, 0
			MOV R8, 019H	;GROUND PLANE
			SPAWNENEMY 228, 52, 0
			JMP ENDCOLUMNTICKEVENTS
		S1E48:
		S1E49:
			CMP RAX, 05AH
			JNZ S1E50
			MOV R8, 025H	;TANKER
			SPAWNENEMY 229, 92, 0
			JMP ENDCOLUMNTICKEVENTS
		S1E50:
			CMP RAX, 05BH
			JNZ S1E51
			MOV R8, 01CH	;UP MISSLE
			SPAWNENEMY 230, 38, 0
			JMP ENDCOLUMNTICKEVENTS
		S1E51:
			CMP RAX, 05DH
			JNZ S1E52
			MOV R8, 01CH	;UP MISSLE
			SPAWNENEMY 229, 92, 0
			JMP ENDCOLUMNTICKEVENTS
		S1E52:
			CMP RAX, 05FH
			JNZ S1E53
			MOV R8, 025H	;TANKER
			SPAWNENEMY 225, 82, 0
			JMP ENDCOLUMNTICKEVENTS
		S1E53:
			CMP RAX, 061H
			JNZ S1E54
			MOV R8, 026H	;SPAWN DISH
			SPAWNENEMY 221, 113, 0
			JMP ENDCOLUMNTICKEVENTS
		S1E54:
			CMP RAX, 065H
			JNZ S1E55
			MOV R8, 01H	;SPAWN ENTRY WALLS
			SPAWNENEMY 50, 0, 0
			JMP ENDCOLUMNTICKEVENTS
		S1E55:
			CMP RAX, 069H
			JNZ S1E56
			MOV HIDESHADOW, 01H	;TURN SHADOW OFF
			JMP ENDCOLUMNTICKEVENTS
		S1E56:
			CMP RAX, 06FH
			JNZ ENDCOLUMNTICKEVENTS
			MOV HIDESHADOW, 00H	;TURN SHADOW BACK ON
			INC STAGE	;MOVE TO NEXT STAGE
		JMP ENDCOLUMNTICKEVENTS
	
	

	ENDCOLUMNTICKEVENTS:
ENDM




MOVEBACKGROUND MACRO
	;MOVE BACKGROUND LAYER 0 OVER 16, DOWN 8
		;SHIFT LAYER ROWS TO DO SO
	;THEN AFTER THE SHIFT IS FINISHED:
		;COPY ALL ROWS DOWN 1, AND OVER 2 TILES
		;RESET SHIFTS
		;LOAD IN NEW EDGE TILES
	LOCAL JUSTXSCROLL
	LOCAL MOVEDOWN1SIDE2
	LOCAL PUSHSCROLL
	LOCAL ENEMIESBACKGROUNDSCROLL
	LOCAL NEXTEBGSCROLL
	LOCAL ENDMOVEBACKGROUND
	
	;CHECK STAGE
	MOV RAX, STAGE
	CMP RAX, 02H
	JA ENDMOVEBACKGROUND
	
	MOV RAX, PAUSESCROLL
	CMP RAX, 00H
	JNZ ENDMOVEBACKGROUND
	
	
	;CHECK FRAMERULE
	INC SCROLLFRAMERULEC
	MOV RAX, SCROLLFRAMERULEC
	CMP RAX, SCROLLFRAMERULE
	JNZ ENDMOVEBACKGROUND
	XOR RAX, RAX
	MOV SCROLLFRAMERULEC, RAX
	
	
	;TESTING TO SHOW OFF:
	INC SCROLLTIMER
	MOV RAX, SCROLLTIMER
		TEST RAX, 01H
		JNZ JUSTXSCROLL
	INC SCROLLY
	JUSTXSCROLL:
	INC SCROLLX
	
	
	MOV RAX, SCROLLX
	CMP RAX,  010H
	JNZ PUSHSCROLL
		;INCREASE COLUMN TICK COUNT
		INC COLUMNTICK
		COLUMNTICKEVENTS
		;RETILE TILE MAP 0
		LEA RBX, QWORD PTR [TILEMAP0]
		MOV R8, 07BEH	;SOURCE OFFSET FROM RBX
		MOV RDX, 07FAH	;DESTINATION OFFSET FROM RBX
		XOR R9, R9
		MOV RCX, 01FH
	MOVEDOWN1SIDE2:
		MOV AX, WORD PTR [RBX + R8]
		MOV WORD PTR [RBX + RDX], AX
		DEC R8
		DEC R8
		DEC RDX
		DEC RDX
		INC R9
		CMP R9, 01EH
		JNZ MOVEDOWN1SIDE2
			;ELSE DECREASE R8 & RDX BY FOUR
			SUB R8, 04H
			SUB RDX, 04H
			XOR R9, R9
			LOOP MOVEDOWN1SIDE2
	
		;RESET SCROLL
		XOR RAX, RAX
		MOV SCROLLX, RAX
		MOV SCROLLY, RAX
		;LOAD NEW SECTION:
		LOADINNEXTSECTIONOFMAP
	
	PUSHSCROLL:
	MOV RAX, 0100H
	SUB RAX, SCROLLX
	MOV BYTE PTR [TM0XOFFSET], AL
	MOV RAX, SCROLLY
	MOV BYTE PTR [TM0YOFFSET], AL
	
	;COMPARE TO LAST SCROLL:
	MOV RAX, SCROLLX
	CMP RAX, LASTSCROLLX
	JZ ENDMOVEBACKGROUND	;IF SAME, NO NEED TO UPDATE ENEMIES
		;ELSE MOVE ENEMIES ALONG WITH THE BACKGROUND
		MOV RCX, SCROLLY
		XOR RCX, LASTSCROOLY
		AND RCX, 01H	;INCREASE Y IF NOT THE SAME
		MOV RDX, 01H
		SHL RDX, CL		;2 IF MOVED Y, 1 IF DIDN'T MOVE Y (USED FOR FASTER SPEED OBJECTS)	
		
		MOV R8, RDX
		MOV R9, 01H		;ALWAYS DECREASE X
		MOV RCX, NUMBEROFENEMY
		LEA RBX, QWORD PTR [ENEMY]
		ENEMIESBACKGROUNDSCROLL:
			PUSH RCX
			MOV AL, BYTE PTR [RBX]
			CMP AL, 00H
			JZ NEXTEBGSCROLL	;NOT ACTIVE
			TEST AL, 02H	;NON-SCROLL EFFECT BIT
			JNZ NEXTEBGSCROLL
				;FOR FASTER SCROLL:
				MOV R10, QWORD PTR [RBX]	;MODE
				AND R10, 080H	;EXTRA SPEED BIT
				SHR R10, 06H				
				;SCROLL X AND Y
					MOV RDX, R8
					MOV RCX, R10
					SHL RDX, CL	;MULTIPLY NUMBER OF TIMES IN R10 FOR SPEED (DEFUALT IS 0)
					SHR RDX, 01H	;DIVIDE BY TWO 
				MOV AL, BYTE PTR [RBX + 06H]	;Y
				ADD AL, DL
				MOV BYTE PTR [RBX + 06H], AL
				MOV AL, BYTE PTR [RBX + 04H]	;X
					MOV RDX, R9
					SHL RDX, CL
				SUB AL, DL	;ALWAYS DECREASE
				MOV BYTE PTR [RBX + 04H], AL
				;DESPAWN WHEN X = 240
				CMP AL, 0F0H
				JB NEXTEBGSCROLL
					;DESPAWN
					XOR RAX, RAX
					MOV WORD PTR [RBX], AX
			NEXTEBGSCROLL:
			POP RCX
			ADD RBX, ENEMYOBJSIZE
			LOOP ENEMIESBACKGROUNDSCROLL
	
		;AND MOVE MODE 2 BOLTS
		MOV RDX, SCROLLY
		XOR RDX, LASTSCROOLY
		AND RDX, 01H	;INCREASE Y IF NOT THE SAME
		MOV RCX, 08H
		LEA RBX, QWORD PTR [BOLTS]
		BOLTSBACKGROUNDSCROLL:
			MOV AL, BYTE PTR [RBX]
			CMP AL, 02H
			JNZ NEXTBBGSCROLL	;ONLY MODE 2 BOLTS
				;SCROLL X AND Y
				MOV AL, BYTE PTR [RBX + 06H]	;Y
				ADD AL, DL
				MOV BYTE PTR [RBX + 06H], AL
				MOV AL, BYTE PTR [RBX + 04H]	;X
				DEC AL	;ALWAYS DECREASE
				MOV BYTE PTR [RBX + 04H], AL
				;DESPAWN WHEN X = 240
				CMP AL, 0F0H
				JNZ NEXTBBGSCROLL
					;DESPAWN
					XOR AL, AL
					MOV BYTE PTR [RBX], AL
			NEXTBBGSCROLL:
			ADD RBX, ENEMYOBJSIZE
			LOOP BOLTSBACKGROUNDSCROLL
	
	ENDMOVEBACKGROUND:
	;STORE LAST SCROLL
	MOV RAX, SCROLLX
	MOV LASTSCROLLX, RAX
	MOV RAX, SCROLLY
	MOV LASTSCROOLY, RAX
ENDM


ENEMYLOGIC MACRO
	LOCAL ENEMYLOGICLOOP
	LOCAL NEXTENEMYLOGIC
	LOCAL EXPLODEENEMYANIMATION
	LOCAL DEADENEMY
	LOCAL ENDENEMYLOGIC
	
	INC ELOGICFRAMERULEC
	MOV RAX, ELOGICFRAMERULEC
	CMP RAX, ELOGICFRAMERULE
	JNZ ENDENEMYLOGIC
		XOR RAX, RAX
		MOV ELOGICFRAMERULEC, RAX
	
	MOV RCX, 00H
	LEA RBX, QWORD PTR [ENEMY]
	ENEMYLOGICLOOP:
		XOR RAX, RAX
		MOV AL, BYTE PTR [RBX]	;MODE
		CMP AL, 00H
		JZ NEXTENEMYLOGIC
		
		;CHECK FOR EXPLOSION TIMER
		MOV AL, BYTE PTR [RBX + 01H]	;MODE HIGH BYTE
		TEST AL, 01H	;EXPLOSION TIMER
		JZ CHECKFORLANDTANKS
			;CHECK FUEL TANKS: 
			MOV AL, BYTE PTR [RBX + 02H]	;SPRITE
			CMP AL, 025H
			JNZ EXPLODEENEMYANIMATION
				;THIS WILL ONLY OCCUR ONCE SINCE THE SPRITE IS ABOUT TO BE CHANGED
				;INCREASE SHIP'S FUEL
				MOV AL, BYTE PTR [SHIPFUEL]
				ADD AX, BONUSFUEL
				CMP AX, 0100H
				JA FULLFUEL
					MOV BYTE PTR [SHIPFUEL], AL
				JMP EXPLODEENEMYANIMATION
				FULLFUEL:
					MOV BYTE PTR [SHIPFUEL], 0FFH
			EXPLODEENEMYANIMATION:
			;INCREASE SPRITES ACCORDING TO TIMER
			MOV AL, BYTE PTR [RBX + 0DH]	;TIMER
			INC AL
			CMP AL, 030	;MAX TIME
			JA DEADENEMY
			SHR AL, 03H	;/8
			AND AL, 01H
			ADD AL, 02FH
			MOV BYTE PTR [RBX + 02H], AL	;SPRITE
			;INCREASE TIMER
			INC BYTE PTR [RBX + 0DH]	;TIMER
			JMP NEXTENEMYLOGIC
		
		CHECKFORLANDTANKS:
		MOV AL, BYTE PTR [RBX + 02H]	;SPRITE
		CMP AL, 023H	;LAND TANK SPRITE
		JNZ CHECKENEMYDELAY
			;RANDOM FIRE ENEMY MISSLES (027H) AT PLAYER
			RNG	;FILL RAX WITH RANDOM VARIABLE
			AND RAX, 03FH
			CMP RAX, 03FH
			JNZ NEXTENEMYLOGIC
			;SPAWN MISSLE
			PUSH RBX
			PUSH RCX
				XOR RAX, RAX
				MOV AL, BYTE PTR [RBX + 04H]	;X
				SUB AL, 018H
				MOV R10, RAX	;DEST X
				MOV AL, BYTE PTR [RBX + 06H]	;Y
				ADD AL, 09H
				MOV R11, RAX	;DEST Y
				MOV R8, 027H	;SPAWN MISSLE
				SPAWNENEMY R10, R11, 0
			POP RCX
			POP RBX
		JMP NEXTENEMYLOGIC
		
		CHECKENEMYDELAY:
		MOV AL, BYTE PTR [RBX]	;MODE
		TEST AL, 20H	;DELAY BIT
		JZ ENEMYGOUP
			;MUST BE BELOW THE MINIMUM Y VALUE OF SHIP
			MOV AL, BYTE PTR [RBX + 06H]	;Y
			ADD AL, 40H
			CMP AL, SHIPORGINY
			JBE ENEMYGOUP
			;CHECK TO END DELAY
			RNG	;FILL RAX WITH RANDOM VARIABLE
			AND RAX, 07FH
			CMP RAX, 07FH
			JNZ NEXTENEMYLOGIC
			;TURN OFF DELAY, INVISIBLE, AND NO HITBOX
			MOV AL, BYTE PTR [RBX]	;MODE
			AND AL, 093H
			MOV BYTE PTR [RBX], AL
			;SPAWN ENEMY FIRE UNDERNEATH	(029H)
			;SPAWN MISSLE
			PUSH RBX
			PUSH RCX
				XOR RAX, RAX
				MOV AL, BYTE PTR [RBX + 04H]	;X
				MOV R10, RAX	;DEST X
				MOV AL, BYTE PTR [RBX + 06H]	;Y
				ADD AL, 04H
				MOV R11, RAX	;DEST Y
				MOV R8, 029H	;SPAWN SPRAY
				SPAWNENEMY R10, R11, 0
			POP RCX
			POP RBX
			
			JMP NEXTENEMYLOGIC
			
		ENEMYGOUP:	
		MOV AL, BYTE PTR [RBX]	;MODE
		XOR AL, 04H
		AND AL, 14H
		CMP AL, 14H	;GO UP BIT + NO INVISIBLE BIT
		JNZ CHECKMISSLELAUNCH			
			;DECREASE Y BY SPEED
			ENEMYFLYSPEED EQU 01
			MOV AL, BYTE PTR [RBX + 06H]	;Y
			SUB AL, ENEMYFLYSPEED
			MOV BYTE PTR [RBX + 06H], AL	;Y
			CMP AL, 020H
			JB DEADENEMY	;TOO HIGH, KILL IT OFF
			;MAINTAIN PROPER ALTITUDE (10px EACH)
			MOV AL, BYTE PTR [RBX + 0DH]	;TIMER
			INC AL
			CMP AL, 0CH
			JB STOREALTTIMER
				;ELSE INCREASE ALTITUDE AND RESET TIMER
				MOV AL, BYTE PTR [RBX + 0CH]
				CMP AL, 03H
				JAE STOREALTTIMER
					INC BYTE PTR [RBX + 0CH]
			STOREALTTIMER:
				MOV BYTE PTR [RBX + 0DH], AL	;TIMER
			JMP NEXTENEMYLOGIC
		
		CHECKMISSLELAUNCH:
		MOV AL, BYTE PTR [RBX + 01H]	;MODE HIGH BYTE
		TEST AL, 02H	;SHORT TIMER BIT
		JZ CHECKBOSS
			;COUNT TO 32, DELETE
			INC BYTE PTR [RBX + 0DH]
			MOV AL, BYTE PTR [RBX + 0DH]	;TIMER
			CMP AL, 010H
			JAE DEADENEMY
				;SET SPRITE:
			SHR AL, 02H
			ADD AL, 029H
			MOV BYTE PTR [RBX + 02H], AL	;SPRITE
			JMP  NEXTENEMYLOGIC
		
		CHECKBOSS:
		MOV AL, BYTE PTR [RBX + 02H]	;SPRITE
		CMP AL, 034H	;BOSS + 3 OTHER SPRITES
		JNZ CHECKFLYMISSLE
			;CHECK HEALTH:
			MOV AL, BYTE PTR [RBX + 01H]
			SHR AL, 02H	;HP
			CMP AL, 00H
			JNZ MOVEBOSS
				;ALREADY DEAD, DESTROY SELF
				XOR RAX, RAX
				MOV WORD PTR [RBX], AX
				MOV WORD PTR [RBX + ENEMYOBJSIZE], AX
				MOV WORD PTR [RBX + ENEMYOBJSIZE*2], AX
				MOV WORD PTR [RBX + ENEMYOBJSIZE*3], AX
				
				;SPAWN EXPLOSION:
				MOV AL, BYTE PTR [RBX + 04H]	;X
				ADD AL, 10H
				MOV R10, RAX
				MOV AL, BYTE PTR [RBX + 06H]	;Y
				ADD AL, 10H
				MOV R11, RAX
				MOV R8, 029H	;SPAWN SPRAY
				PUSH RBX
				PUSH RCX
					SPAWNENEMY R10, R11, 0
				POP RCX
				POP RBX
				;SET WIN TIME OUT
					INC WINTIMER
				JMP NEXTENEMYLOGIC
			MOVEBOSS:
			;RANDOMLY LAUNCH MISSLE
			RNG	;FILL RAX WITH RANDOM VARIABLE
			AND RAX, 07FH
			CMP RAX, 07FH
			JNZ MOVETHEBOSS
			;SPAWN MISSLE
			PUSH RBX
			PUSH RCX
				XOR RAX, RAX
				MOV AL, BYTE PTR [RBX + 04H]	;X
				ADD AL, 0FH
				MOV R10, RAX	;DEST X
				MOV AL, BYTE PTR [RBX + 06H]	;Y
				ADD AL, 0EH
				MOV R11, RAX	;DEST Y
				MOV R8, 01BH	;SPAWN MISSLE
				SPAWNENEMY R10, R11, 0
			POP RCX
			POP RBX
			
			MOVETHEBOSS:
			INC BOSSMOVEFRAMERULEC
			MOV RAX, BOSSMOVEFRAMERULEC
			CMP RAX, BOSSMOVEFRAMERULE
			JNZ NEXTENEMYLOGIC
			MOV BOSSMOVEFRAMERULEC, 00H
			;IF TIMER == 0 GO LEFT, IF TIMER == 1 GO RIGHT
			MOV AL, BYTE PTR [RBX + 0DH]	;TIMER
			CMP AL, 00H
			JZ MOVEBOSSLEFT
			MOVEBOSSRIGHT:
				MOV AL, BYTE PTR [RBX + 06H]	;Y
				ADD AL, 01H
				MOV BYTE PTR [RBX + 06H], AL
				MOV BYTE PTR [RBX + 06H + ENEMYOBJSIZE], AL
				ADD AL, 020H
				MOV BYTE PTR [RBX + 06H + ENEMYOBJSIZE*2], AL
				MOV BYTE PTR [RBX + 06H + ENEMYOBJSIZE*3], AL
				
				MOV AL, BYTE PTR [RBX + 04H]	;X
				ADD AL, 02H
				MOV BYTE PTR [RBX + 04H], AL
				MOV BYTE PTR [RBX + 04H + ENEMYOBJSIZE*2], AL
				ADD AL, 020H
				MOV BYTE PTR [RBX + 04H + ENEMYOBJSIZE], AL
				MOV BYTE PTR [RBX + 04H + ENEMYOBJSIZE*3], AL
				CMP AL, 0E6H
				JBE NEXTENEMYLOGIC
					;ELSE RESET TO MOVE LEFT 
				MOV BYTE PTR [RBX + 0DH], 00H	;TIMER
				
			MOVEBOSSLEFT:
				MOV AL, BYTE PTR [RBX + 06H]	;Y
				SUB AL, 01H
				MOV BYTE PTR [RBX + 06H], AL
				MOV BYTE PTR [RBX + 06H + ENEMYOBJSIZE], AL
				ADD AL, 020H
				MOV BYTE PTR [RBX + 06H + ENEMYOBJSIZE*2], AL
				MOV BYTE PTR [RBX + 06H + ENEMYOBJSIZE*3], AL
				
				MOV AL, BYTE PTR [RBX + 04H]	;X
				SUB AL, 02H
				MOV BYTE PTR [RBX + 04H], AL
				MOV BYTE PTR [RBX + 04H + ENEMYOBJSIZE*2], AL
				ADD AL, 020H
				MOV BYTE PTR [RBX + 04H + ENEMYOBJSIZE], AL
				MOV BYTE PTR [RBX + 04H + ENEMYOBJSIZE*3], AL
				CMP AL, 08CH
				JA NEXTENEMYLOGIC
					;ELSE RESET TO MOVE RIGHT 
				MOV BYTE PTR [RBX + 0DH], 01H	;TIMER
				
			
			JMP NEXTENEMYLOGIC
		
		CHECKFLYMISSLE:
		MOV AL, BYTE PTR [RBX]
		TEST AL, 080H	;FLY BIT
		JZ NEXTENEMYLOGIC
			MOV RAX, PAUSESCROLL
			CMP AL, 00H
			JZ NEXTENEMYLOGIC
			;FLY MISSLES (BECAUSE THE SCREEN IS PAUSED WHEN BOSS IS LAUNCHED
			MOV AL, BYTE PTR [RBX + 06H]	;Y
			ADD AL, 01H
			MOV BYTE PTR [RBX + 06H], AL	;Y
			MOV AL, BYTE PTR [RBX + 04H]	;X
			SUB AL, 02H
			MOV BYTE PTR [RBX + 04H], AL	;X
			CMP AL, 0F0H
			JA DEADENEMY			
			
			JMP NEXTENEMYLOGIC
		
		DEADENEMY:
			XOR RAX, RAX
			MOV WORD PTR [RBX], AX
	NEXTENEMYLOGIC:
		ADD RBX, ENEMYOBJSIZE
		INC RCX
		CMP RCX, NUMBEROFENEMY
		JNZ ENEMYLOGICLOOP
	
	ENDENEMYLOGIC:
ENDM



CHECKHITBOXES MACRO
	;CALCULATING AND CHECKING ALL HITBOXES:
	;CALCULATING MAIN SHIP HITBOX:
	LOCAL ENEMYHITCHECK
	LOCAL STANDARDALTCHECK
	LOCAL EXTENSIVEALTCHECK
	LOCAL COMPAREHITBOX
	LOCAL NEXTENEMYHITCHECK
	
	LOCAL CALCBOLTBOX
	LOCAL ENEMYHITCHECK2
	LOCAL NEXTENEMYHITCHECK2
	LOCAL COMPAREHITBOX2
	LOCAL EXTENSIVEALTCHECK2
	LOCAL NEXTBOLTBOX
	LOCAL NORMALENEMYHIT
	

	;SET SHIP LOCATION IN SPRITES:		
		;DEPENDING ON SIZE OF SHIP:
		;DEFAULT SIZE:
		MOV AL, 12	;WIDTH
		MOV BYTE PTR [SHIPHITBOX + 02H], AL
		MOV AL, 8	;HEIGHT
		MOV BYTE PTR [SHIPHITBOX + 03H], AL
		MOV R8, 0BH	;X-OFFSET
		MOV R9, 0CH	;Y-OFFSET
		;LOCATION X
		MOV RAX, SHIPORGINX
		ADD RAX, SHIPX
		ADD RAX, R8
		MOV BYTE PTR [SHIPHITBOX], AL
		MOV RAX, SHIPORGINY
		MOV RBX, SHIPY
		SHR RBX, 01H
		ADD RAX, RBX
		ADD RAX, SHIPTILTY
		ADD RAX, R9
		MOV BYTE PTR [SHIPHITBOX + 01H], AL
		
	;CHECKING SHIP AND ENEMY COLLISIONS:
		;MUST BE ON SAME ALTITUDE UNLESS 4TH BIT IN ENEMY MODE IS SET (IN WHICH CASE ONLY ALTITUDE AND LOWER WILL HIT)
	LEA RDX, QWORD PTR [ENEMY]
	XOR RAX, RAX
	MOV HIT, RAX 
	XOR R8, R8
	XOR RCX, RCX
	ENEMYHITCHECK:
		;CHECK IF ACTIVE
		MOV AL, BYTE PTR [RDX]
		CMP AL, 00H
		JZ NEXTENEMYHITCHECK
		MOV AL, BYTE PTR [RDX + 0DH]
		CMP AL, 00H
		JNZ NEXTENEMYHITCHECK
		;IS ACTIVE, CHECK HITBOX, ESCPAE ONCE CONDITION FALSE
		;COMPARE ALTITUDES:
			MOV AL, BYTE PTR [RDX]
			TEST AL, 08H		;SPECIAL TALL HITBOX
			JNZ EXTENSIVEALTCHECK
			TEST AL, 040H	;NO CHECK HITBOX BIT
			JNZ NEXTENEMYHITCHECK
			STANDARDALTCHECK:
				MOV AL, BYTE PTR [SHIPALT]
				CMP AL, BYTE PTR [RDX + 0CH]
				JNZ NEXTENEMYHITCHECK	;DIFFERENT ALTITUDES, SHIPS IN THE NIGHT
				JMP COMPAREHITBOX
			EXTENSIVEALTCHECK:
				MOV AL, BYTE PTR [HIDESHADOW]
				CMP AL, 00H
				JZ NEXTENEMYHITCHECK	;HIDE SHADOW MUST ALSO BE TURNED ON
				MOV AL, BYTE PTR [SHIPALT]
				CMP AL, BYTE PTR [RDX + 0CH]
				JA NEXTENEMYHITCHECK	;ONLY ESCAPE IF ALTITUDE IS GREATER
				;JMP COMPAREHITBOX
		
		COMPAREHITBOX:
		;X PREP
		MOV BL, BYTE PTR [RDX + 04H]	;EX
		ADD BL, BYTE PTR [RDX + 08H]	;EX OFFSET
		;X1+W1 >= X2 && X2+W2 >= X1
		MOV AL, BYTE PTR [SHIPHITBOX] 		;X
		ADD AL, BYTE PTR [SHIPHITBOX + 02H] ;+W
		CMP AL, BYTE PTR BL
		JB NEXTENEMYHITCHECK
		ADD BL, BYTE PTR [RDX + 0AH]	;EW
		CMP BL, BYTE PTR [SHIPHITBOX]
		JB NEXTENEMYHITCHECK
		;Y PREP
		MOV BL, BYTE PTR [RDX + 06H]	;EY
		ADD BL, BYTE PTR [RDX + 09H]	;EY OFFSET
		;Y1+H1 >= Y2 && Y2+H2 >= Y2
		MOV AL, BYTE PTR [SHIPHITBOX + 01H]	;Y
		ADD AL, BYTE PTR [SHIPHITBOX + 03H]	;+H
		CMP AL, BYTE PTR BL
		JB NEXTENEMYHITCHECK
		ADD BL, BYTE PTR [RDX + 0BH]	;EH
		CMP BL, BYTE PTR [SHIPHITBOX + 01H]
		JB NEXTENEMYHITCHECK
			;CONNECTED
			INC R8
	NEXTENEMYHITCHECK:
		ADD RDX, ENEMYOBJSIZE
		INC RCX
		CMP RCX, NUMBEROFENEMY
		JNZ ENEMYHITCHECK
	MOV HIT, R8
	
	
	
	
	;COMPARE PLAYER BOLTS AGAINST ENEMY HIT BOXES
	MOV RCX, 00H	;NUMBER OF BOLTS COUNTER
	LEA RBX, QWORD PTR [BOLTS]
	CALCBOLTBOX:	;STORE BOLT VALUES IN R8(X),  R9(Y), R10(X+W), R11(Y+H)
		MOV AL, BYTE PTR [RBX]	;MODE
		CMP AL, 01H	;ONLY ALLOW FLYING BOLTS TO COLLIDE
		JNZ NEXTBOLTBOX
		XOR RAX, RAX
		MOV AL, BYTE PTR [RBX + 04H]	;X
		ADD AL, BYTE PTR [RBX + 08H]	;X OFFSET
		MOV R8, RAX
		ADD AL, BYTE PTR [RBX + 0AH]	;WIDTH
		MOV R10, RAX
		MOV AL, BYTE PTR [RBX + 06H]	;Y
		ADD AL, BYTE PTR [RBX + 09H]	;Y OFFSET
		MOV R9, RAX
		ADD AL, BYTE PTR [RBX + 0BH]	;HEIGHT
		MOV R11, RAX
		MOV R12, RBX
		PUSH RCX
	;PREPARE ENEMY DATA:
	LEA RDX, QWORD PTR [ENEMY]
	XOR RCX, RCX
	ENEMYHITCHECK2: 
		;CHECK IF ACTIVE
		MOV AL, BYTE PTR [RDX]
		CMP AL, 00H
		JZ NEXTENEMYHITCHECK2
		MOV AL, BYTE PTR [RDX + 0DH]
		CMP AL, 00H
		JNZ NEXTENEMYHITCHECK2
		;IS ACTIVE, CHECK HITBOX, ESCPAE ONCE CONDITION FALSE
		;COMPARE ALTITUDES:
			MOV AL, BYTE PTR [RDX]
			TEST AL, 08H		;SPECIAL TALL HITBOX
			JNZ EXTENSIVEALTCHECK2
			TEST AL, 040H	;NO CHECK HITBOX BIT
			JNZ NEXTENEMYHITCHECK2
			;STANDARD ALTITUDE CHECK:
				MOV AL, BYTE PTR [R12 + 0CH]	;BOLT ALTITUDE
				CMP AL, BYTE PTR [RDX + 0CH]	;ENEMY ALTITUDE
				JNZ NEXTENEMYHITCHECK2	;DIFFERENT ALTITUDES, SHIPS IN THE NIGHT
				JMP COMPAREHITBOX2
			EXTENSIVEALTCHECK2:
				MOV AL, BYTE PTR [R12 + 0CH]	;BOLT ALTITUDE
				CMP AL, BYTE PTR [RDX + 0CH]
				JA NEXTENEMYHITCHECK2	;ONLY ESCAPE IF ALTITUDE IS GREATER
		
		COMPAREHITBOX2:
		;X PREP
		MOV BL, BYTE PTR [RDX + 04H]	;EX
		ADD BL, BYTE PTR [RDX + 08H]	;EX OFFSET
		;X1+W1 >= X2 && X2+W2 >= X1
		MOV RAX, R10	;BOLT X+W
		CMP AL, BL
		JB NEXTENEMYHITCHECK2
		ADD BL, BYTE PTR [RDX + 0AH]	;EW
		MOV RAX, R8		;BOLT X
		CMP BL, AL
		JB NEXTENEMYHITCHECK2
		;Y PREP
		MOV BL, BYTE PTR [RDX + 06H]	;EY
		ADD BL, BYTE PTR [RDX + 09H]	;EY OFFSET
		;Y1+H1 >= Y2 && Y2+H2 >= Y2
		MOV RAX, R9
		CMP AL, BL
		JB NEXTENEMYHITCHECK2
		ADD BL, BYTE PTR [RDX + 0BH]	;EH
		MOV RAX, R11
		CMP BL, AL
		JB NEXTENEMYHITCHECK2
			;CONNECTED, SET EACH MODE TO 2 TO EXPLODE THEM
			MOV AL, 02H
			MOV BYTE PTR [R12], AL
			MOV BL, BYTE PTR [RDX]	;MODE FOR ENEMY
			TEST BL, 08H			;SPECIAL TALL HITBOX
			JNZ NEXTENEMYHITCHECK2	;IF TALL, DON'T DELETE IT
			;CHECK IF BOSS
			MOV AL, BYTE PTR [RDX + 02H]	;SPRITE
			CMP AL, 034H
			JNZ NORMALENEMYHIT	;NOT THE BOSS
			;DECREASE HP BY 1
			MOV AL, BYTE PTR [RDX + 01H]	;CHECK FOR HIT POINTS
			SUB AL, 04H
			MOV BYTE PTR [RDX + 01H], AL	;NORMALLY THIS WOULD ERASE OTHER BITS, BUT I KNOW THEY'RE NOT SET
			JMP NEXTENEMYHITCHECK2
			NORMALENEMYHIT:
			MOV BYTE PTR [RDX + 01H], 01H	;START THE DEATH TIMER
			MOV BYTE PTR [RDX + 0DH], 00H	;RESET INTERNAL TIMER
			
	NEXTENEMYHITCHECK2:
		ADD RDX, ENEMYOBJSIZE
		INC RCX
		CMP RCX, NUMBEROFENEMY
		JNZ ENEMYHITCHECK2
	
	POP RCX
	MOV RBX, R12
	NEXTBOLTBOX:
	ADD RBX, BOLTOBJSIZE
	INC RCX
	CMP RCX, 08H
	JNZ CALCBOLTBOX
	
	
ENDM

SHIPEXPLODE MACRO	
	;EXPLODE THE SHIP:
	INC EXPLODEFRAMERULEC
	MOV RAX, EXPLODEFRAMERULEC
	CMP RAX, EXPLODEFRAMERULE
	JNZ ENDSHIPEXPLODE
		XOR RAX, RAX
		MOV EXPLODEFRAMERULEC, RAX
		
		;INCREASE EXPLOSION:
		LEA RDX, QWORD PTR [SPRITES]
		MOV RAX, EXPLODETIMER
		ADD AL, 029H
		MOV BYTE PTR [RDX + 02H], AL 	;SPRITES
		INC EXPLODETIMER
		MOV RAX, EXPLODETIMER
		CMP AL, 06H
		JNZ ENDSHIPEXPLODE
			;END GAME
			INC RESET
	
	ENDSHIPEXPLODE:
ENDM

GAMELOGIC MACRO	
	MOV RAX, HIT
	CMP RAX, 00H
	JZ NOTHIT
		MOV AL, BYTE PTR [SPRITES + 02H]
		CMP AL, 020H
		JA AFTERSETREDSPRITE
			MOV BYTE PTR [SPRITES + 02H], 03FH
		AFTERSETREDSPRITE:
		;SET MODE TO HIT
		MOV RAX, 0FFH	;DEATH MODE
		MOV STAGE, RAX
		INC EXPLODEDELAYTIMER
		MOV RAX, EXPLODEDELAYTIMER
		CMP RAX, 040H
		JB AFTERLOGIC
		SHIPEXPLODE
		JMP AFTERLOGIC
	NOTHIT:
	
		MOVESHIP
		MOVEBACKGROUND
		ENEMYLOGIC
		CHECKHITBOXES
	
	AFTERLOGIC:
	
	MOV RAX, WINTIMER
	CMP RAX, 00H
	JZ AFTERWT
		INC WINTIMER
		MOV RAX, WINTIMER
		CMP RAX, 0C0H
		JNZ AFTERWT
			RESETTITLE	
	AFTERWT:
	MOV RAX, RESET
	CMP RAX, 00H
	JZ NORESET
		RESETGAME
	NORESET:
ENDM

RENDERSPRITE MACRO
    LOCAL AFTERPLOTSPRITEPIXEL
    LOCAL POSTTILESSELECTED
    LOCAL SPRITEPIXELLOOP
    LOCAL NOTNEXTPIXELYET2
    
    SHR RAX, 10H
    XOR RBX, RBX
    MOV BX, AX
    SHL RBX, 0CH
    
    LEA RDX, QWORD PTR [spriteTiles]
    CMP SPRITEVERSION, 00H
    JZ POSTTILESSELECTED
        LEA RDX, QWORD PTR [spriteTiles2]
POSTTILESSELECTED:
    ADD RBX, RDX
    LEA RDX, QWORD PTR [OUTPUTFBUFFER]
    SHR RAX, 10H
    XOR R8, R8
    XOR R9, R9
    MOV R8, RAX
    AND R8, 0FFH
    SHL R8, 02H
    MOV R9, RAX
    SHR R9, 06H
    AND R9, 03FC00H
    ADD RDX, R8
    ADD RDX, R9
    MOV RCX, 20H
    XOR R8, R8
SPRITEPIXELLOOP:
    MOV EAX, DWORD PTR [RBX]
        CMP EAX, 00H
        JZ AFTERPLOTSPRITEPIXEL
    MOV DWORD PTR [RDX], EAX
AFTERPLOTSPRITEPIXEL:
    ADD RBX, 04H
    ADD RDX, 04H
    INC R8
    TEST R8, 01FH
    JNZ SPRITEPIXELLOOP
        ADD RDX, 0380H
        XOR R8, R8
    LOOP SPRITEPIXELLOOP
ENDM

RENDERGRAPHICS MACRO
    LOCAL ENEMIESTOSPRITES
    LOCAL NEXTENEMYSPRITE
    LOCAL BOLTTOSPRITES
    LOCAL NEXTBOLTSPRITE
    LOCAL RENDERTILEMAP0
    LOCAL RENDERTILEMAP1
    LOCAL AFTERTM1TILE
    LOCAL RESETUPSCALEVALLOOP
    LOCAL SENDTOSCREEN
    LOCAL AMPLIFYLOOP
    LOCAL AFTERSENDTOSCREEN
    LOCAL HARDWAREACCEL
    LOCAL RENDERSPRITELOOP
    LOCAL SPRITELOOPTAIL
    LOCAL SKIPRESET
    
    ; RENDER BOLTS TO SPRITES
    LEA RBX, QWORD PTR [BOLTS]
    LEA RDX, QWORD PTR [SPRITES]
    ADD RDX, 080H
    MOV RCX, 08H
BOLTTOSPRITES:
    XOR RAX, RAX
    MOV [RDX], RAX
    MOV AL, BYTE PTR [RBX]
    CMP AL, 00H
    JZ NEXTBOLTSPRITE
        MOV RAX, [RBX]
        MOV [RDX], RAX
NEXTBOLTSPRITE:
    ADD RBX, BOLTOBJSIZE
    ADD RDX, 08H
    LOOP BOLTTOSPRITES
    
    ; RENDER ENEMIES TO SPRITES
    LEA RBX, QWORD PTR [ENEMY]
    MOV RCX, NUMBEROFENEMY
ENEMIESTOSPRITES:
    XOR RAX, RAX
    MOV [RDX], RAX
    MOV AL, BYTE PTR [RBX]
    CMP AL, 00H
    JZ NEXTENEMYSPRITE
    TEST AL, 04H
    JNZ NEXTENEMYSPRITE
        MOV RAX, [RBX]
        MOV [RDX], RAX
NEXTENEMYSPRITE:
    ADD RBX, ENEMYOBJSIZE
    ADD RDX, 08H
    LOOP ENEMIESTOSPRITES
    
    ; RENDER TILE MAP 0
    XOR RBX, RBX
    LEA RDX, TILEMAP0
RENDERTILEMAP0:
    XOR RAX, RAX
    MOV AX, WORD PTR [RDX + RBX]
        PUSH RBX
        PUSH RDX
        SHR RBX, 01H
    RENDERTILE 00H
        POP RDX
        POP RBX
    INC RBX
    INC RBX
    CMP RBX, 0800H
    JNZ RENDERTILEMAP0
    
    ; RENDER SPRITES BACK TO FRONT
    LEA RBX, QWORD PTR [SPRITES]
    ADD RBX, 03F8H
    MOV RCX, 00H
RENDERSPRITELOOP:
    MOV RAX, QWORD PTR [RBX]
    CMP AL, 00H
    JZ SPRITELOOPTAIL
        PUSH RBX
        PUSH RCX
        RENDERSPRITE
        POP RCX
        POP RBX
SPRITELOOPTAIL:
    SUB RBX, 08H
    INC RCX
    CMP RCX, 080H
    JNZ RENDERSPRITELOOP

    ; RENDER TILE MAP 1
    XOR RBX, RBX
    LEA R8, TILEMAP1
RENDERTILEMAP1:
    XOR RAX, RAX
    MOV AX, WORD PTR [R8 + RBX]
    CMP AX, 00H
    JZ AFTERTM1TILE
        PUSH RBX
        PUSH R8
        SHR RBX, 01H
    RENDERTILE 01H
        POP R8
        POP RBX
AFTERTM1TILE:
    INC RBX
    INC RBX
    CMP RBX, 0800H
    JNZ RENDERTILEMAP1

    ; OUTPUT GRAPHICS TO SCREEN
    MOV RAX, UPSCALE_MODE
    CMP RAX, 00H
    JZ HARDWAREACCEL
        LEA RDX, QWORD PTR [OUTPUTFBUFFER]
        BLTBUFF 0, 0, 512, 384, 256, 256
    JMP AFTERSENDTOSCREEN

HARDWAREACCEL:
    MOV RCX, 020H
    MOV RAX, 00H
    LEA RBX, QWORD PTR [UPSCALEDROW]
RESETUPSCALEVALLOOP:
    MOV QWORD PTR [RBX], RAX
    ADD RBX, 08H
    LOOP RESETUPSCALEVALLOOP
    MOV QWORD PTR [UPSCALEDCOUNT], RAX

    MOV RCX, MPServices
    LEA RDX, [PARALLELRENDERTOSCREEN]
    MOV R8, 00H
    MOV R9, 00H
    SUB RSP, 8
    PUSH QWORD PTR [FAILEDCPULIST]
    PUSH 00H
    PUSH 00H
    CALL StartupAllAPs
    
    MOV RAX, QWORD PTR [UPSCALEDCOUNT]
    OUTPUT64BITNUMBER 00H
    
    MOV RAX, QWORD PTR [UPSCALEDCOUNT]
    CMP RAX, 00H
    JNZ SKIPRESET
        INC UPSCALE_MODE
        RESETTITLE
SKIPRESET:
    
    MOV RDX, UPSCALEDBUFFER
    BLTBUFF 0, 0, 128, 0, 1024, 1024
    
AFTERSENDTOSCREEN:
ENDM

RENDERHITBOXES MACRO
    LOCAL ENEMYRENDERHBLOOP
    LOCAL NEXTEHB
    LOCAL BOLTRENDERHBLOOP
    LOCAL NEXTBHB
    
    ; SHOW SHIP HITBOX
    XOR RAX, RAX
    MOV AL, BYTE PTR [SHIPHITBOX]
    MOV R10, RAX
        SHL R10, 02H
        ADD R10, 080H
    MOV AL, BYTE PTR [SHIPHITBOX + 01H]
    MOV R11, RAX
        SHL R11, 02H
    MOV AL, BYTE PTR [SHIPHITBOX + 02H]
    MOV R12, RAX
        SHL R12, 02H
    MOV AL, BYTE PTR [SHIPHITBOX + 03H]
    MOV R13, RAX
        SHL R13, 02H
    
    LEA RDX, QWORD PTR [COLORRED]
    XOR RAX, RAX
    MOV AL, BYTE PTR [SHIPALT]
    SHL RAX, 02H
    ADD RDX, RAX
    BLTRECT 0, 0, R10, R11, R12, R13
    
    ; ENEMY HITBOXES
    MOV RCX, NUMBEROFENEMY
    LEA RBX, QWORD PTR [ENEMY]
ENEMYRENDERHBLOOP:
    MOV AL, BYTE PTR [RBX]
    CMP AL, 00H
    JZ NEXTEHB
    
    XOR RAX, RAX
    MOV AL, BYTE PTR [RBX + 04H]
    ADD AL, BYTE PTR [RBX + 08H]
    MOV R10, RAX
        SHL R10, 02H
        ADD R10, 080H
    MOV AL, BYTE PTR [RBX + 06H]
    ADD AL, BYTE PTR [RBX + 09H]
    MOV R11, RAX
        SHL R11, 02H
    MOV AL, BYTE PTR [RBX + 0AH]
    MOV R12, RAX
        SHL R12, 02H
    MOV AL, BYTE PTR [RBX + 0BH]
    MOV R13, RAX
        SHL R13, 02H
    
    LEA RDX, QWORD PTR [COLORRED]
    XOR RAX, RAX
    MOV AL, BYTE PTR [RBX + 0CH]
    SHL RAX, 02H
    ADD RDX, RAX
        PUSH RBX
        PUSH RCX
    BLTRECT 0, 0, R10, R11, R12, R13
        POP RCX
        POP RBX
NEXTEHB:
    ADD RBX, ENEMYOBJSIZE
    DEC RCX
    CMP RCX, 00H
    JNZ ENEMYRENDERHBLOOP
    
    ; BOLT HITBOXES
    MOV RCX, 08H
    LEA RBX, QWORD PTR [BOLTS]
BOLTRENDERHBLOOP:
    MOV AL, BYTE PTR [RBX]
    CMP AL, 00H
    JZ NEXTBHB
    
    XOR RAX, RAX
    MOV AL, BYTE PTR [RBX + 04H]
    ADD AL, BYTE PTR [RBX + 08H]
    MOV R10, RAX
        SHL R10, 02H
        ADD R10, 080H
    MOV AL, BYTE PTR [RBX + 06H]
    ADD AL, BYTE PTR [RBX + 09H]
    MOV R11, RAX
        SHL R11, 02H
    MOV AL, BYTE PTR [RBX + 0AH]
    MOV R12, RAX
        SHL R12, 02H
    MOV AL, BYTE PTR [RBX + 0BH]
    MOV R13, RAX
        SHL R13, 02H
    
    LEA RDX, QWORD PTR [COLORRED]
    XOR RAX, RAX
    MOV AL, BYTE PTR [RBX + 0CH]
    SHL RAX, 02H
    ADD RDX, RAX
        PUSH RBX
        PUSH RCX
    BLTRECT 0, 0, R10, R11, R12, R13
        POP RCX
        POP RBX
NEXTBHB:
    ADD RBX, BOLTOBJSIZE
    DEC RCX
    CMP RCX, 00H
    JNZ BOLTRENDERHBLOOP
ENDM

GRAPHICSINIT MACRO
    LOCAL TILEMAPLOOP1
    LOCAL TILEMAPLOOP2
    LOCAL TITLECARDLOOP
    LOCAL TILEMAPTOPLOOP
    
    LEA RDX, QWORD PTR [COLORBLACK]
    BLTRECT 0, 0, 0, 0, 1280, 1024
    
    LEA RBX, QWORD PTR [TILEMAP0]
    ADD RBX, 05EH
    LEA RDX, QWORD PTR [tilemap]
    XOR R8, R8
    MOV RCX, 014H
TILEMAPLOOP1:
    MOV AX, WORD PTR [RDX]
    MOV WORD PTR [RBX], AX
    INC RBX
    INC RBX
    INC RDX
    INC RDX
    INC R8
    CMP R8, 0FH
    JNZ TILEMAPLOOP1
        XOR R8, R8
        ADD RBX, 022H
    LOOP TILEMAPLOOP1
    
    LEA RBX, QWORD PTR [TILEMAP1]
    MOV RCX, 020H
    MOV RAX, 05EDH
    XOR R8, R8
TILEMAPTOPLOOP:
    MOV WORD PTR [RBX + R8], AX
    INC R8
    INC R8
    LOOP TILEMAPTOPLOOP
    
    MOV RDX, RBX
    ADD RDX, 03CH
    XOR R8, R8
    MOV RCX, 00H
    MOV RAX, 05EDH
TILEMAPLOOP2:
    MOV WORD PTR [RBX + R8], AX
    MOV WORD PTR [RDX + R8], AX
    INC R8
    INC R8
    INC RCX
    TEST RCX, 01H
    JNZ TILEMAPLOOP2
        ADD R8, 03CH
    CMP RCX, 040H
    JNZ TILEMAPLOOP2
    LOADINNEXTSECTIONOFMAP
    
    MOV RCX, 12H
    LEA RDX, QWORD PTR [TITLECARD]
    LEA RBX, QWORD PTR [TILEMAP1]
    ADD RBX, 018H
TITLECARDLOOP:
    MOV AX, WORD PTR [RDX]
    MOV WORD PTR [RBX], AX
    INC RBX
    INC RBX
    INC RDX
    INC RDX
    LOOP TITLECARDLOOP
    
    LEA RBX, QWORD PTR [TILEMAP1]
    ADD RBX, 0204H
    MOV RAX, 064DH
    MOV WORD PTR [RBX], AX
    ADD RBX, 0140H
    MOV RAX, 0643H
    MOV WORD PTR [RBX], AX
    
    LEA RBX, QWORD PTR [SPRITES]
    MOV RAX, 046000C00000001H
    MOV QWORD PTR [RBX], RAX
    
    LEA RBX, QWORD PTR [SPRITES + 08H]
    MOV RAX, 0DC00B0003B0001H
    MOV QWORD PTR [RBX], RAX
    
    LEA RBX, QWORD PTR [SPRITES + 10H]
    MOV RAX, 0E000B0003A0001H
    MOV QWORD PTR [RBX], RAX
    
    LEA RBX, QWORD PTR [SPRITES + 18H]
    MOV RAX, 0E000D0003C0001H
    MOV QWORD PTR [RBX], RAX
    
    LEA RBX, QWORD PTR [SPRITES + 03F8H]
    MOV RAX, 0000000000C0001H
    MOV QWORD PTR [RBX], RAX
    
    MOV AL, 0FFH
    MOV BYTE PTR [SHIPFUEL], AL
ENDM

ENDIF
