; MACROS_UTIL.INC - Utility macros

IFNDEF MACROS_UTIL_INC
MACROS_UTIL_INC EQU 1

RNG MACRO
    LOCAL GETRND
    LOCAL RETRYRNG
    LOCAL EXITRNG
    ; ATTEMPT TO GET A 64-BIT RANDOM VALUE IN RAX
    MOV RCX, 010H
GETRND:
    RDRAND RAX
    JNC RETRYRNG
    JMP EXITRNG
RETRYRNG:
    LOOP GETRND
EXITRNG:
ENDM

OUTPUT64BITNUMBER MACRO newline
    LOCAL CONVERTTODIGITLOOP
    LOCAL REVERSELOOP
    LOCAL CLEARLOOP
    LOCAL WRITE64
    ; RCX = digit count
    MOV RCX, 3FH
    LEA RBX, [BUFFER]
    LEA RDX, [bMessage]
CLEARLOOP:
    MOV BYTE PTR [RBX + RCX], 00H
    MOV BYTE PTR [RDX + RCX], 00H
    LOOP CLEARLOOP

    XOR RCX, RCX
    MOV RSI, 10
CONVERTTODIGITLOOP:
    XOR RDX, RDX
    DIV RSI
    ADD DL, 30H
    MOV [RBX + RCX], DL
    INC RCX
    TEST RAX, RAX
    JNZ CONVERTTODIGITLOOP

    LEA RDI, [bMessage]
REVERSELOOP:
    DEC RCX
    MOV AL, [RBX + RCX]
    MOV BYTE PTR [RDI], AL
    INC RDI
    INC RDI
    TEST RCX, RCX
    JNZ REVERSELOOP
    
    MOV AL, newline
    CMP AL, 00H
    JNZ WRITE64
    MOV BYTE PTR [RDI], 13
    MOV BYTE PTR [RDI + 2], 10
WRITE64:
    MOV RCX, conOut
    LEA RDX, [bMessage]
    CALL OutputString
ENDM

RESETCONSOLEPOSITION MACRO
    MOV RCX, conOut
    MOV RDX, 00H
    MOV R8, 00H
    CALL SetCursorPosition
ENDM

ENDIF
